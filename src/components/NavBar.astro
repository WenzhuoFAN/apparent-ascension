---
const { active = "" } = Astro.props;
const items = [
  { href: "/", label: "首页", key: "home" },
  { href: "/start", label: "小海诺/心球仪速成指南", key: "start" },
  { href: "/schedule", label: "日程表", key: "schedule" },
  { href: "/library", label: "精选内容", key: "library" },
  { href: "/streams", label: "直播记录", key: "streams" },
  { href: "/stats", label: "粉丝数据", key: "stats" },
];

const memberLinks = [
  {
    key: "fiona",
    uid: "3537115310721181",
    href: "https://space.bilibili.com/3537115310721181",
    label: "心宜",
    avatar: "/images/Fiona.jpg",
  },
  {
    key: "gladys",
    uid: "3537115310721781",
    href: "https://space.bilibili.com/3537115310721781",
    label: "思诺",
    avatar: "/images/Gladys.jpg",
  },
];
---
<header class="container" style="padding-top: 18px;">
  <nav class="nav">
    <div class="brand">
      <div class="title">闪耀舞台</div>
    </div>

    <div class="links" role="navigation" aria-label="Site">
      {items.map((it) => (
        <a class:list={["a", active === it.key && "active"]} href={it.href}>
          {it.label}
        </a>
      ))}
    </div>

    <div class="ext">
      {memberLinks.map((member) => (
        <a class="pill member-pill" href={member.href} target="_blank" rel="noreferrer">
          <img class="avatar" src={member.avatar} alt="" width="24" height="24" loading="lazy" decoding="async" />
          <span class="pill-label">{member.label}</span>
          <span class="pill-live" data-live-badge={member.key} hidden aria-live="polite">
            <span class="live-dot" aria-hidden="true"></span>
            <span class="live-text">live</span>
          </span>
        </a>
      ))}
    </div>
  </nav>
</header>

<script is:inline>
  const LIVE_MEMBERS = [
    { key: "fiona", uid: "3537115310721181" },
    { key: "gladys", uid: "3537115310721781" },
  ];
  const LIVE_STATUS_API = "https://api.live.bilibili.com/room/v1/Room/getRoomInfoOld?mid=";
  const LIVE_CHECK_INTERVAL_MS = 60 * 1000;
  const liveBadges = new Map(
    Array.from(document.querySelectorAll("[data-live-badge]")).map((node) => [node.getAttribute("data-live-badge"), node])
  );

  const setLiveBadge = (memberKey, isLive) => {
    const badge = liveBadges.get(memberKey);
    if (!badge) return;
    badge.hidden = !isLive;
  };

  const isLiveByUid = async (uid) => {
    const controller = new AbortController();
    const timeout = window.setTimeout(() => controller.abort(), 6000);

    try {
      const response = await fetch(`${LIVE_STATUS_API}${uid}`, {
        method: "GET",
        mode: "cors",
        cache: "no-store",
        signal: controller.signal,
      });
      if (!response.ok) return null;

      const json = await response.json();
      if (json?.code !== 0) return null;

      return Number(json?.data?.liveStatus) === 1;
    } catch {
      return null;
    } finally {
      window.clearTimeout(timeout);
    }
  };

  const refreshLiveBadges = async () => {
    const statuses = await Promise.all(
      LIVE_MEMBERS.map(async (member) => ({
        key: member.key,
        live: await isLiveByUid(member.uid),
      }))
    );

    statuses.forEach(({ key, live }) => {
      if (live === null) return;
      setLiveBadge(key, live);
    });
  };

  if (liveBadges.size) {
    refreshLiveBadges();
    window.setInterval(refreshLiveBadges, LIVE_CHECK_INTERVAL_MS);
    document.addEventListener("visibilitychange", () => {
      if (!document.hidden) refreshLiveBadges();
    });
  }
</script>

<style lang="scss">
@use "../styles/mixins" as m;

.nav{
  @include m.glass;
  border-radius: var(--r-lg);
  padding: 14px 14px;
  display: grid;
  grid-template-columns: 1fr auto auto;
  gap: 10px;
  align-items: center;
}

.brand{
  display: flex;
  align-items: center;
}
.title{
  font-weight: 700;
  letter-spacing: .6px;
}

.links{
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  justify-content: center;
}
.a{
  padding: 8px 10px;
  border-radius: 999px;
  font-size: 13px;
  color: rgba(255,255,255,.72);
  border: 1px solid transparent;
  transition: background var(--dur) var(--ease), border-color var(--dur) var(--ease), transform var(--dur) var(--ease);
}
.a:hover{
  background: rgba(255,255,255,.06);
  border-color: rgba(255,255,255,.10);
  transform: translateY(-1px);
}
.a.active{
  background: rgba(255,255,255,.10);
  border-color: rgba(255,255,255,.14);
  color: rgba(255,255,255,.92);
}

.ext{
  display: flex;
  gap: 8px;
  justify-content: end;
}
.pill{
  border-radius: 999px;
  font-size: 12px;
  color: rgba(255,255,255,.82);
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.16);
  transition: transform var(--dur) var(--ease), background var(--dur) var(--ease);
}
.pill:hover{
  transform: translateY(-1px);
  background: rgba(0,0,0,.24);
}

.member-pill{
  display: grid;
  grid-template-columns: 24px auto auto;
  align-items: center;
  column-gap: 8px;
  min-height: 40px;
  padding: 7px 8px;
  white-space: nowrap;
}
.avatar{
  width: 24px;
  height: 24px;
  border-radius: 999px;
  object-fit: cover;
  border: 1px solid rgba(255,255,255,.22);
  background: rgba(255,255,255,.14);
}
.pill-label{
  white-space: nowrap;
  line-height: 1;
}

.pill-live{
  justify-self: end;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 2px 7px;
  border-radius: 999px;
  border: 1px solid rgba(90,235,142,.45);
  background: rgba(27,123,67,.25);
  color: rgba(201,255,219,.92);
  font-size: 10px;
  line-height: 1;
  text-transform: uppercase;
  letter-spacing: .4px;
}
.live-dot{
  width: 7px;
  height: 7px;
  border-radius: 999px;
  background: #4ef08b;
  box-shadow: 0 0 8px rgba(78,240,139,.95);
  animation: live-pulse 1.5s ease-in-out infinite;
}
@keyframes live-pulse{
  0%{ transform: scale(.95); box-shadow: 0 0 6px rgba(78,240,139,.65); }
  60%{ transform: scale(1.08); box-shadow: 0 0 12px rgba(78,240,139,.95); }
  100%{ transform: scale(.95); box-shadow: 0 0 6px rgba(78,240,139,.65); }
}

@media (max-width: 980px){
  .nav{ grid-template-columns: 1fr; }
  .ext{ justify-content: start; flex-wrap: wrap; }
  .links{ justify-content: start; }
}
</style>
