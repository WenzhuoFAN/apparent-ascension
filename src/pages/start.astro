---
import BaseLayout from "../layouts/BaseLayout.astro";
import NavBar from "../components/NavBar.astro";
import Section from "../components/Section.astro";
import Card from "../components/Card.astro";
import { getCollection } from "astro:content";

const mustTag = "å…¥å‘å¿…çœ‹";
const kiloTag = "åƒå…‹å¿…çœ‹";
const allClips = await getCollection("clips");
const allFanworks = await getCollection("fanworks");

const mustClips = allClips.filter((x) => x.data.tags.includes(mustTag)).slice(0, 6);
const mustFanworks = allFanworks.filter((x) => x.data.tags.includes(mustTag)).slice(0, 6);
const kiloClips = allClips.filter((x) => x.data.tags.includes(kiloTag)).slice(0, 6);
const kiloFanworks = allFanworks.filter((x) => x.data.tags.includes(kiloTag)).slice(0, 6);
---
<BaseLayout title="å…¥å‘ï½œé—ªè€€èˆå°" description="æ–°ç²‰è·¯çº¿ï¼šå…ˆçœ‹ä»€ä¹ˆã€å†çœ‹ä»€ä¹ˆã€è¡¥è¯¾æ¸…å•">
  <NavBar slot="nav" active="start" />

  <h1 class="h1">æ–°ç²‰å…¥å‘è·¯çº¿ ğŸ§­</h1>

  <Section title="å…ˆè®¤è¯†å¥¹ä»¬">
    <div class="grid cols-2">
      <Card href="/members/fiona" title="å¿ƒå®œï¼ˆFionaï¼‰" desc="æˆå‘˜é¡µï¼šå…³é”®è¯ã€é£æ ¼ã€æ¨èè§‚çœ‹æ¸…å•ã€å¸¸ç”¨é“¾æ¥ã€‚" avatar="/images/Fiona.jpg" />
      <Card href="/members/gladys" title="æ€è¯ºï¼ˆGladysï¼‰" desc="æˆå‘˜é¡µï¼šå…³é”®è¯ã€é£æ ¼ã€æ¨èè§‚çœ‹æ¸…å•ã€å¸¸ç”¨é“¾æ¥ã€‚" avatar="/images/Gladys.jpg" />
    </div>
  </Section>

  <Section title="å…¥å‘å¿…çœ‹">
    <div class="admin-bar">
      <button class="admin-btn" id="open-rec-admin" type="button">ç¼–è¾‘</button>
    </div>

    <div class="grid cols-3" id="must-rec-grid">
      {[...mustClips, ...mustFanworks].slice(0, 6).map((r) => (
        <a class="rec rec-static" href={r.data.url} target="_blank" rel="noreferrer">
          <div class="t">{r.data.title}</div>
          {r.data.cover && <img class="cover" src={r.data.cover} alt="" loading="lazy" referrerpolicy="no-referrer" />}
          <div class="d">{r.data.reason ?? ""}</div>
        </a>
      ))}
    </div>

    {!mustClips.length && !mustFanworks.length && (
      <p class="p" id="must-empty-msg">ä½ è¿˜æ²¡æ ‡æ³¨ â€œå…¥å‘å¿…çœ‹â€ çš„æ¨èæ¡ç›®ã€‚å» src/content/clips æˆ– fanworks é‡Œç»™ tags åŠ ä¸Šå®ƒå³å¯ã€‚</p>
    )}
  </Section>

  <Section title="åƒå…‹å¿…çœ‹">
    <div class="grid cols-3" id="kilo-rec-grid">
      {[...kiloClips, ...kiloFanworks].slice(0, 6).map((r) => (
        <a class="rec rec-static" href={r.data.url} target="_blank" rel="noreferrer">
          <div class="t">{r.data.title}</div>
          {r.data.cover && <img class="cover" src={r.data.cover} alt="" loading="lazy" referrerpolicy="no-referrer" />}
          <div class="d">{r.data.reason ?? ""}</div>
        </a>
      ))}
    </div>

    {!kiloClips.length && !kiloFanworks.length && (
      <p class="p" id="kilo-empty-msg">ä½ è¿˜æ²¡æ ‡æ³¨ â€œåƒå…‹å¿…çœ‹â€ çš„æ¨èæ¡ç›®ã€‚å» src/content/clips æˆ– fanworks é‡Œç»™ tags åŠ ä¸Šå®ƒå³å¯ã€‚</p>
    )}
  </Section>

  <div class="admin-modal" id="rec-admin-modal" hidden>
    <div class="admin-panel">
      <div class="admin-head">
        <h3>æ¨èæ¡ç›®ç¼–è¾‘</h3>
        <button class="admin-close" id="close-rec-admin" type="button" aria-label="å…³é—­">Ã—</button>
      </div>

      <div class="admin-grid">
        <label class="field full">
          <span>Bç«™è§†é¢‘é“¾æ¥</span>
          <input id="rec-link-input" placeholder="https://www.bilibili.com/video/BV..." type="url" />
        </label>

        <label class="field">
          <span>æ¿å—</span>
          <select id="rec-section-input">
            <option value="must">å…¥å‘å¿…çœ‹</option>
            <option value="kilo">åƒå…‹å¿…çœ‹</option>
          </select>
        </label>

        <div class="field actions">
          <span>è‡ªåŠ¨é…ç½®</span>
          <button class="admin-btn" id="fetch-rec-meta" type="button">æŠ“å–æ ‡é¢˜å’Œå°é¢</button>
        </div>

        <label class="field full">
          <span>æ ‡é¢˜</span>
          <input id="rec-title-input" placeholder="è‡ªåŠ¨æŠ“å–åå¯å†æ‰‹æ”¹" type="text" />
        </label>

        <label class="field full">
          <span>å°é¢é“¾æ¥</span>
          <input id="rec-cover-input" placeholder="è‡ªåŠ¨æŠ“å–åä¼šå¡«å¥½" type="url" />
        </label>

        <div class="field full">
          <span>å°é¢é¢„è§ˆ</span>
          <img class="cover-preview" id="rec-cover-preview" alt="" hidden />
        </div>

        <label class="field full">
          <span>è¯´æ˜ï¼ˆä½ è‡ªå·±å†™ï¼‰</span>
          <textarea id="rec-reason-input" rows="3" placeholder="ä¾‹å¦‚ï¼šå…ˆçœ‹è¿™ä¸ªåˆè¾‘ï¼Œå¿«é€Ÿè®¤è¯†ç»å…¸æ¢—ã€‚"></textarea>
        </label>
      </div>

      <p class="admin-status" id="rec-admin-status"></p>

      <div class="admin-actions">
        <button class="admin-btn primary" id="save-rec-entry" type="button">ä¿å­˜åˆ°é¡µé¢</button>
        <button class="admin-btn" id="cancel-rec-entry" type="button">å–æ¶ˆ</button>
      </div>

      <div class="admin-list">
        <div class="admin-list-title">å·²ä¿å­˜ï¼ˆæœ¬æœºæµè§ˆå™¨ï¼‰</div>
        <div id="rec-admin-list"></div>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const STORAGE_KEY = "start.custom.recs.v1";
      const VIEW_API = "https://api.bilibili.com/x/web-interface/view";

      const mustGrid = document.getElementById("must-rec-grid");
      const kiloGrid = document.getElementById("kilo-rec-grid");
      const mustEmpty = document.getElementById("must-empty-msg");
      const kiloEmpty = document.getElementById("kilo-empty-msg");

      const modal = document.getElementById("rec-admin-modal");
      const openBtn = document.getElementById("open-rec-admin");
      const closeBtn = document.getElementById("close-rec-admin");
      const cancelBtn = document.getElementById("cancel-rec-entry");
      const fetchBtn = document.getElementById("fetch-rec-meta");
      const saveBtn = document.getElementById("save-rec-entry");

      const linkInput = document.getElementById("rec-link-input");
      const sectionInput = document.getElementById("rec-section-input");
      const titleInput = document.getElementById("rec-title-input");
      const coverInput = document.getElementById("rec-cover-input");
      const reasonInput = document.getElementById("rec-reason-input");
      const statusEl = document.getElementById("rec-admin-status");
      const listEl = document.getElementById("rec-admin-list");
      const coverPreview = document.getElementById("rec-cover-preview");

      if (!mustGrid || !kiloGrid || !modal || !openBtn || !closeBtn || !cancelBtn || !fetchBtn || !saveBtn) return;
      if (!linkInput || !sectionInput || !titleInput || !coverInput || !reasonInput || !statusEl || !listEl || !coverPreview) return;

      const showStatus = (msg, isErr = false) => {
        statusEl.textContent = msg || "";
        statusEl.classList.toggle("err", !!isErr);
      };

      const normalizeUrl = (url) => String(url || "").trim();
      const normalizeCover = (url) => normalizeUrl(url).replace(/^http:\/\//i, "https://");

      const parseVideoId = (url) => {
        const raw = normalizeUrl(url);
        if (!raw) return null;

        const bv = raw.match(/BV[0-9A-Za-z]{10}/i);
        if (bv) return { bvid: bv[0] };

        const av = raw.match(/(?:\/av|aid=)(\d+)/i);
        if (av) return { aid: av[1] };

        return null;
      };

      const readCustom = () => {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed)) return [];
          return parsed.filter((x) =>
            x &&
            (x.section === "must" || x.section === "kilo") &&
            typeof x.url === "string" &&
            typeof x.title === "string"
          );
        } catch {
          return [];
        }
      };

      const writeCustom = (items) => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
      };

      const createCard = (item) => {
        const a = document.createElement("a");
        a.className = "rec rec-custom";
        a.href = item.url;
        a.target = "_blank";
        a.rel = "noreferrer";

        const t = document.createElement("div");
        t.className = "t";
        t.textContent = item.title;
        a.appendChild(t);

        if (item.cover) {
          const img = document.createElement("img");
          img.className = "cover";
          img.src = item.cover;
          img.alt = "";
          img.loading = "lazy";
          img.referrerPolicy = "no-referrer";
          a.appendChild(img);
        }

        const d = document.createElement("div");
        d.className = "d";
        d.textContent = item.reason || "";
        a.appendChild(d);

        return a;
      };

      const updateEmptyState = () => {
        const custom = readCustom();
        const mustHasCustom = custom.some((x) => x.section === "must");
        const kiloHasCustom = custom.some((x) => x.section === "kilo");
        const mustHasStatic = !!mustGrid.querySelector(".rec-static");
        const kiloHasStatic = !!kiloGrid.querySelector(".rec-static");

        if (mustEmpty) mustEmpty.hidden = mustHasStatic || mustHasCustom;
        if (kiloEmpty) kiloEmpty.hidden = kiloHasStatic || kiloHasCustom;
      };

      const renderAdminList = () => {
        const items = readCustom();
        listEl.innerHTML = "";

        if (!items.length) {
          const p = document.createElement("p");
          p.className = "p";
          p.textContent = "æš‚æ— æœ¬åœ°ä¿å­˜æ¡ç›®ã€‚";
          listEl.appendChild(p);
          return;
        }

        items.forEach((item) => {
          const row = document.createElement("div");
          row.className = "admin-item";

          const left = document.createElement("div");
          const name = document.createElement("div");
          name.textContent = item.title;
          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = `${item.section === "must" ? "å…¥å‘å¿…çœ‹" : "åƒå…‹å¿…çœ‹"} Â· ${item.url}`;
          left.append(name, meta);

          const del = document.createElement("button");
          del.className = "admin-delete";
          del.type = "button";
          del.textContent = "åˆ é™¤";
          del.addEventListener("click", () => {
            const next = readCustom().filter((x) => x.id !== item.id);
            writeCustom(next);
            renderCustomCards();
            renderAdminList();
            showStatus("å·²åˆ é™¤ã€‚");
          });

          row.append(left, del);
          listEl.appendChild(row);
        });
      };

      const renderCustomCards = () => {
        document.querySelectorAll(".rec-custom").forEach((x) => x.remove());

        const items = readCustom();
        const mustItems = items.filter((x) => x.section === "must").reverse();
        const kiloItems = items.filter((x) => x.section === "kilo").reverse();

        mustItems.forEach((item) => mustGrid.prepend(createCard(item)));
        kiloItems.forEach((item) => kiloGrid.prepend(createCard(item)));
        updateEmptyState();
      };

      const resetForm = () => {
        linkInput.value = "";
        sectionInput.value = "must";
        titleInput.value = "";
        coverInput.value = "";
        reasonInput.value = "";
        coverPreview.hidden = true;
        coverPreview.removeAttribute("src");
        showStatus("");
      };

      const openModal = () => {
        modal.hidden = false;
        renderAdminList();
      };

      const closeModal = () => {
        modal.hidden = true;
        resetForm();
      };

      const syncCoverPreview = () => {
        const src = normalizeCover(coverInput.value);
        if (!src) {
          coverPreview.hidden = true;
          coverPreview.removeAttribute("src");
          return;
        }
        coverPreview.src = src;
        coverPreview.hidden = false;
      };

      const fetchMeta = async () => {
        const link = normalizeUrl(linkInput.value);
        const id = parseVideoId(link);

        if (!id) {
          showStatus("é“¾æ¥é‡Œæ²¡è¯†åˆ«åˆ° BV/av å·ã€‚", true);
          return;
        }

        showStatus("æ­£åœ¨æŠ“å–æ ‡é¢˜å’Œå°é¢...");
        try {
          const qs = new URLSearchParams(id).toString();
          const resp = await fetch(`${VIEW_API}?${qs}`);
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

          const json = await resp.json();
          if (!json || json.code !== 0 || !json.data) {
            throw new Error(json?.message || "Bç«™æ¥å£è¿”å›å¼‚å¸¸");
          }

          titleInput.value = json.data.title || "";
          coverInput.value = normalizeCover(json.data.pic || "");
          syncCoverPreview();
          showStatus("å·²è‡ªåŠ¨å¡«å¥½æ ‡é¢˜å’Œå°é¢ã€‚");
        } catch (err) {
          const msg = err instanceof Error ? err.message : String(err);
          showStatus(`æŠ“å–å¤±è´¥ï¼š${msg}ã€‚ä½ ä¹Ÿå¯ä»¥æ‰‹åŠ¨å¡«å†™æ ‡é¢˜å’Œå°é¢ã€‚`, true);
        }
      };

      const saveEntry = () => {
        const item = {
          id: (globalThis.crypto?.randomUUID?.() || `${Date.now()}-${Math.random()}`).toString(),
          section: sectionInput.value === "kilo" ? "kilo" : "must",
          url: normalizeUrl(linkInput.value),
          title: normalizeUrl(titleInput.value),
          cover: normalizeCover(coverInput.value),
          reason: normalizeUrl(reasonInput.value),
          createdAt: new Date().toISOString(),
        };

        if (!item.url) {
          showStatus("è¯·å…ˆè¾“å…¥è§†é¢‘é“¾æ¥ã€‚", true);
          return;
        }
        if (!item.title) {
          showStatus("è¯·å…ˆæŠ“å–æˆ–å¡«å†™æ ‡é¢˜ã€‚", true);
          return;
        }

        const next = [item, ...readCustom()].slice(0, 60);
        writeCustom(next);
        renderCustomCards();
        renderAdminList();
        showStatus("ä¿å­˜æˆåŠŸï¼Œé¡µé¢å·²æ›´æ–°ã€‚");
      };

      openBtn.addEventListener("click", openModal);
      closeBtn.addEventListener("click", closeModal);
      cancelBtn.addEventListener("click", closeModal);
      fetchBtn.addEventListener("click", fetchMeta);
      saveBtn.addEventListener("click", saveEntry);
      coverInput.addEventListener("input", syncCoverPreview);

      modal.addEventListener("click", (event) => {
        if (event.target === modal) closeModal();
      });

      renderCustomCards();
    })();
  </script>

  <style lang="scss">
  @use "../styles/mixins" as m;

  .rec{
    @include m.glass;
    @include m.hover-float;
    border-radius: var(--r-lg);
    padding: 14px 14px;
    display: block;
  }
  .cover{
    width: 100%;
    aspect-ratio: 16 / 9;
    object-fit: cover;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.14);
    margin: 8px 0 10px;
    display: block;
  }
  .t{ font-weight: 700; margin-bottom: 6px; }
  .d{ color: rgba(255,255,255,.65); font-size: 13px; min-height: 34px; }

  .admin-bar{
    display: flex;
    justify-content: flex-end;
    margin-bottom: 10px;
  }
  .admin-btn{
    border: 1px solid rgba(255,255,255,.16);
    border-radius: 999px;
    background: rgba(20,20,30,.5);
    color: rgba(255,255,255,.9);
    padding: 6px 12px;
    font-size: 13px;
    cursor: pointer;
    transition: border-color var(--dur) var(--ease), background var(--dur) var(--ease);
  }
  .admin-btn:hover{
    border-color: rgba(255,255,255,.32);
    background: rgba(40,40,60,.64);
  }
  .admin-btn.primary{
    background: rgba(74, 206, 148, .2);
    border-color: rgba(74, 206, 148, .5);
    color: rgba(224,255,241,.98);
  }

  .admin-modal{
    position: fixed;
    inset: 0;
    z-index: 80;
    display: grid;
    place-items: center;
    background: rgba(0,0,0,.56);
    padding: 16px;
  }
  .admin-panel{
    width: min(760px, 100%);
    max-height: min(86vh, 900px);
    overflow: auto;
    border-radius: 20px;
    padding: 16px;
    @include m.glass;
  }
  .admin-head{
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }
  .admin-head h3{
    margin: 0;
    font-size: 18px;
  }
  .admin-close{
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 1px solid rgba(255,255,255,.2);
    background: rgba(0,0,0,.3);
    color: rgba(255,255,255,.9);
    cursor: pointer;
  }
  .admin-grid{
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .field{
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .field.full{ grid-column: 1 / -1; }
  .field span{
    font-size: 12px;
    color: rgba(255,255,255,.78);
  }
  .field input,
  .field textarea,
  .field select{
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,.16);
    background: rgba(0,0,0,.34);
    color: rgba(255,255,255,.92);
    padding: 10px;
    font-size: 14px;
    font-family: inherit;
  }
  .field textarea{
    resize: vertical;
    min-height: 76px;
  }
  .field.actions{
    justify-content: flex-end;
  }
  .cover-preview{
    width: 100%;
    max-width: 320px;
    aspect-ratio: 16 / 9;
    object-fit: cover;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.2);
  }
  .admin-status{
    min-height: 20px;
    margin: 12px 0 0;
    color: rgba(255,255,255,.86);
    font-size: 13px;
  }
  .admin-status.err{
    color: rgb(255 171 171);
  }
  .admin-actions{
    display: flex;
    gap: 8px;
    margin-top: 8px;
  }
  .admin-list{
    margin-top: 12px;
    border-top: 1px solid rgba(255,255,255,.14);
    padding-top: 12px;
  }
  .admin-list-title{
    font-size: 13px;
    color: rgba(255,255,255,.72);
    margin-bottom: 6px;
  }
  .admin-item{
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    padding: 8px 0;
    border-bottom: 1px dashed rgba(255,255,255,.12);
  }
  .admin-item .meta{
    color: rgba(255,255,255,.72);
    font-size: 12px;
  }
  .admin-delete{
    border: 1px solid rgba(255, 163, 163, .45);
    background: rgba(120, 20, 20, .22);
    color: rgba(255,220,220,.96);
    border-radius: 999px;
    padding: 4px 10px;
    font-size: 12px;
    cursor: pointer;
  }

  @media (max-width: 720px){
    .admin-grid{
      grid-template-columns: 1fr;
    }
  }
  </style>
</BaseLayout>
