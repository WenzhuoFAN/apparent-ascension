---
import BaseLayout from "../layouts/BaseLayout.astro";
import NavBar from "../components/NavBar.astro";
import Section from "../components/Section.astro";
import { getCollection } from "astro:content";

const memberIntroCards = [
  {
    id: "fiona",
    name: "å¿ƒå®œï¼ˆFionaï¼‰",
    avatar: "/images/Fiona.jpg",
    summary: "æ ¹æ®èŒå¨˜ç™¾ç§‘æ¡ç›®ï¼šå¿ƒå®œæ˜¯ç½‘ç»œè™šæ‹Ÿä¸»æ’­ï¼Œéš¶å±ææ±Ÿå¨±ä¹ï¼Œ2023å¹´10æœˆ15æ—¥å¼€å§‹æ´»åŠ¨ã€‚",
    links: [
      { label: "æˆå‘˜é¡µ", href: "/members/fiona" },
      { label: "èŒå¨˜ç™¾ç§‘", href: "https://zh.moegirl.org.cn/%E5%BF%83%E5%AE%9C" },
    ],
  },
  {
    id: "gladys",
    name: "æ€è¯ºï¼ˆGladysï¼‰",
    avatar: "/images/Gladys.jpg",
    summary: "æ ¹æ®èŒå¨˜ç™¾ç§‘æ¡ç›®ï¼šæ€è¯ºæ˜¯ç½‘ç»œè™šæ‹Ÿä¸»æ’­ï¼Œéš¶å±ææ±Ÿå¨±ä¹ï¼Œ2023å¹´11æœˆ3æ—¥å¼€å§‹æ´»åŠ¨ã€‚",
    links: [
      { label: "æˆå‘˜é¡µ", href: "/members/gladys" },
      { label: "èŒå¨˜ç™¾ç§‘", href: "https://zh.moegirl.org.cn/%E6%80%9D%E8%AF%BA" },
    ],
  },
];

const mustTag = "å…¥å‘å¿…çœ‹";
const kiloTag = "åƒå…‹å¿…çœ‹";
const allClips = await getCollection("clips");
const allFanworks = await getCollection("fanworks");
const adminKeyHash = (import.meta.env.PUBLIC_START_ADMIN_KEY_HASH ?? "").trim().toLowerCase();

const mustClips = allClips.filter((x) => x.data.tags.includes(mustTag)).slice(0, 6);
const mustFanworks = allFanworks.filter((x) => x.data.tags.includes(mustTag)).slice(0, 6);
const kiloClips = allClips.filter((x) => x.data.tags.includes(kiloTag)).slice(0, 6);
const kiloFanworks = allFanworks.filter((x) => x.data.tags.includes(kiloTag)).slice(0, 6);
---
<BaseLayout title="å…¥å‘ï½œé—ªè€€èˆå°" description="æ–°ç²‰è·¯çº¿ï¼šå…ˆçœ‹ä»€ä¹ˆã€å†çœ‹ä»€ä¹ˆã€è¡¥è¯¾æ¸…å•">
  <NavBar slot="nav" active="start" />

  <h1 class="h1">æ–°ç²‰å…¥å‘è·¯çº¿ ğŸ§­</h1>

  <Section title="å…ˆè®¤è¯†å¥¹ä»¬">
    <div class="grid cols-2 intro-grid">
      {memberIntroCards.map((m) => (
        <article class="intro-card">
          <div class="intro-top">
            <img class="intro-avatar" src={m.avatar} alt="" width="38" height="38" loading="lazy" decoding="async" />
            <div class="intro-name">{m.name}</div>
          </div>

          <p class="intro-snippet">{m.summary}</p>

          <div class="intro-links">
            {m.links.map((link) => (
              <a
                class="intro-link"
                href={link.href}
                target={link.href.startsWith("http") ? "_blank" : undefined}
                rel={link.href.startsWith("http") ? "noreferrer" : undefined}
              >
                {link.label}
              </a>
            ))}
          </div>
        </article>
      ))}
    </div>
    <p class="p intro-note">ä¸Šé¢ç®€ä»‹ä¸ºå¯¹èŒå¨˜ç™¾ç§‘è¯æ¡çš„ç®€è¦æ•´ç†ï¼Œå®Œæ•´ä¿¡æ¯è¯·ç‚¹â€œèŒå¨˜ç™¾ç§‘â€æŸ¥çœ‹ã€‚</p>
  </Section>

  <Section title="å…¥å‘å¿…çœ‹">
    <div class="admin-bar">
      <button class="admin-btn" id="open-rec-admin" type="button" hidden>ç¼–è¾‘</button>
    </div>

    <div class="grid cols-3" id="must-rec-grid">
      {[...mustClips, ...mustFanworks].slice(0, 6).map((r) => (
        <a
          class="rec rec-static"
          data-source="static"
          data-section="must"
          data-rec-key={`must:${r.collection}:${r.id}`}
          href={r.data.url}
          target="_blank"
          rel="noreferrer"
        >
          <div class="t">{r.data.title}</div>
          {r.data.cover && <img class="cover" src={r.data.cover} alt="" loading="lazy" referrerpolicy="no-referrer" />}
          <div class="d">{r.data.reason ?? ""}</div>
        </a>
      ))}
    </div>

    {!mustClips.length && !mustFanworks.length && (
      <p class="p" id="must-empty-msg">ä½ è¿˜æ²¡æ ‡æ³¨ â€œå…¥å‘å¿…çœ‹â€ çš„æ¨èæ¡ç›®ã€‚å» src/content/clips æˆ– fanworks é‡Œç»™ tags åŠ ä¸Šå®ƒå³å¯ã€‚</p>
    )}
  </Section>

  <Section title="åƒå…‹å¿…çœ‹">
    <div class="grid cols-3" id="kilo-rec-grid">
      {[...kiloClips, ...kiloFanworks].slice(0, 6).map((r) => (
        <a
          class="rec rec-static"
          data-source="static"
          data-section="kilo"
          data-rec-key={`kilo:${r.collection}:${r.id}`}
          href={r.data.url}
          target="_blank"
          rel="noreferrer"
        >
          <div class="t">{r.data.title}</div>
          {r.data.cover && <img class="cover" src={r.data.cover} alt="" loading="lazy" referrerpolicy="no-referrer" />}
          <div class="d">{r.data.reason ?? ""}</div>
        </a>
      ))}
    </div>

    {!kiloClips.length && !kiloFanworks.length && (
      <p class="p" id="kilo-empty-msg">ä½ è¿˜æ²¡æ ‡æ³¨ â€œåƒå…‹å¿…çœ‹â€ çš„æ¨èæ¡ç›®ã€‚å» src/content/clips æˆ– fanworks é‡Œç»™ tags åŠ ä¸Šå®ƒå³å¯ã€‚</p>
    )}
  </Section>

  <div class="admin-modal" id="rec-admin-modal" hidden>
    <div class="admin-panel">
      <div class="admin-head">
        <h3>æ¨èæ¡ç›®ç¼–è¾‘</h3>
        <button class="admin-close" id="close-rec-admin" type="button" aria-label="å…³é—­">Ã—</button>
      </div>

      <div class="admin-grid">
        <label class="field full">
          <span>Bç«™è§†é¢‘é“¾æ¥</span>
          <input id="rec-link-input" placeholder="https://www.bilibili.com/video/BV..." type="url" />
        </label>

        <label class="field">
          <span>æ¿å—ï¼ˆç”± + ä½ç½®å†³å®šï¼‰</span>
          <select id="rec-section-input" disabled>
            <option value="must">å…¥å‘å¿…çœ‹</option>
            <option value="kilo">åƒå…‹å¿…çœ‹</option>
          </select>
        </label>

        <div class="field actions">
          <span>è‡ªåŠ¨é…ç½®</span>
          <button class="admin-btn" id="fetch-rec-meta" type="button">æŠ“å–æ ‡é¢˜å’Œå°é¢</button>
        </div>

        <label class="field full">
          <span>æ ‡é¢˜</span>
          <input id="rec-title-input" placeholder="è‡ªåŠ¨æŠ“å–åå¯å†æ‰‹æ”¹" type="text" />
        </label>

        <label class="field full">
          <span>å°é¢é“¾æ¥</span>
          <input id="rec-cover-input" placeholder="è‡ªåŠ¨æŠ“å–åä¼šå¡«å¥½" type="url" />
        </label>

        <div class="field full">
          <span>å°é¢é¢„è§ˆ</span>
          <img class="cover-preview" id="rec-cover-preview" alt="" hidden />
        </div>

        <label class="field full">
          <span>è¯´æ˜ï¼ˆä½ è‡ªå·±å†™ï¼‰</span>
          <textarea id="rec-reason-input" rows="3" placeholder="ä¾‹å¦‚ï¼šå…ˆçœ‹è¿™ä¸ªåˆè¾‘ï¼Œå¿«é€Ÿè®¤è¯†ç»å…¸æ¢—ã€‚"></textarea>
        </label>
      </div>

      <p class="admin-status" id="rec-admin-status"></p>

      <div class="admin-actions">
        <button class="admin-btn primary" id="save-rec-entry" type="button">ä¿å­˜åˆ°é¡µé¢</button>
        <button class="admin-btn" id="cancel-rec-entry" type="button">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <script define:vars={{ adminKeyHash }}>
    (() => {
      const STORAGE_KEY = "start.custom.recs.v1";
      const HIDDEN_STATIC_KEY = "start.hidden.static.recs.v1";
      const ADMIN_AUTH_SESSION_KEY = "start.admin.authed.v1";
      const VIEW_API = "https://api.bilibili.com/x/web-interface/view";
      const ADMIN_KEY_HASH = String(adminKeyHash || "").trim().toLowerCase();
      let isAdmin = ADMIN_KEY_HASH.length === 0;
      let editMode = false;

      const mustGrid = document.getElementById("must-rec-grid");
      const kiloGrid = document.getElementById("kilo-rec-grid");
      const mustEmpty = document.getElementById("must-empty-msg");
      const kiloEmpty = document.getElementById("kilo-empty-msg");

      const modal = document.getElementById("rec-admin-modal");
      const openBtn = document.getElementById("open-rec-admin");
      const closeBtn = document.getElementById("close-rec-admin");
      const cancelBtn = document.getElementById("cancel-rec-entry");
      const fetchBtn = document.getElementById("fetch-rec-meta");
      const saveBtn = document.getElementById("save-rec-entry");

      const linkInput = document.getElementById("rec-link-input");
      const sectionInput = document.getElementById("rec-section-input");
      const titleInput = document.getElementById("rec-title-input");
      const coverInput = document.getElementById("rec-cover-input");
      const reasonInput = document.getElementById("rec-reason-input");
      const statusEl = document.getElementById("rec-admin-status");
      const coverPreview = document.getElementById("rec-cover-preview");

      if (!mustGrid || !kiloGrid || !modal || !openBtn || !closeBtn || !cancelBtn || !fetchBtn || !saveBtn) return;
      if (!linkInput || !sectionInput || !titleInput || !coverInput || !reasonInput || !statusEl || !coverPreview) return;

      const showStatus = (msg, isErr = false) => {
        statusEl.textContent = msg || "";
        statusEl.classList.toggle("err", !!isErr);
      };

      const normalizeUrl = (url) => String(url || "").trim();
      const normalizeCover = (url) => normalizeUrl(url).replace(/^http:\/\//i, "https://");

      const parseVideoId = (url) => {
        const raw = normalizeUrl(url);
        if (!raw) return null;

        const bv = raw.match(/BV[0-9A-Za-z]{10}/i);
        if (bv) return { bvid: bv[0] };

        const av = raw.match(/(?:\/av|aid=)(\d+)/i);
        if (av) return { aid: av[1] };

        return null;
      };

      const readHiddenStatic = () => {
        try {
          const raw = localStorage.getItem(HIDDEN_STATIC_KEY);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed.filter((x) => typeof x === "string") : [];
        } catch {
          return [];
        }
      };

      const writeHiddenStatic = (keys) => {
        localStorage.setItem(HIDDEN_STATIC_KEY, JSON.stringify(keys));
      };

      const parseAdminKeyCandidates = () => {
        const url = new URL(window.location.href);
        const keys = [];
        const fromQuery = url.searchParams.get("admin");
        if (fromQuery) keys.push(fromQuery);

        const fromPath = url.pathname.match(/\/start\/([^/?#]+)/i);
        if (fromPath?.[1]) keys.push(fromPath[1]);

        const hash = url.hash.replace(/^#/, "");
        const hashKV = hash.match(/^admin=(.+)$/i);
        if (hashKV?.[1]) keys.push(decodeURIComponent(hashKV[1]));
        const hashPath = hash.match(/^\/?admin\/(.+)$/i);
        if (hashPath?.[1]) keys.push(decodeURIComponent(hashPath[1]));

        return keys.filter((x) => x && x.length > 0);
      };

      const clearAdminKeyFromUrl = () => {
        const url = new URL(window.location.href);
        const hadQuery = url.searchParams.has("admin");
        if (hadQuery) url.searchParams.delete("admin");

        const hash = url.hash.replace(/^#/, "");
        const hadHash = /^admin=.+$/i.test(hash) || /^\/?admin\/.+$/i.test(hash);
        if (hadHash) url.hash = "";

        if (hadQuery || hadHash) {
          history.replaceState({}, "", `${url.pathname}${url.search}${url.hash}`);
        }
      };

      const sha256Hex = async (text) => {
        const raw = new TextEncoder().encode(text);
        const buf = await crypto.subtle.digest("SHA-256", raw);
        return Array.from(new Uint8Array(buf))
          .map((b) => b.toString(16).padStart(2, "0"))
          .join("");
      };

      const fetchViaJsonp = (url, timeoutMs = 12000) =>
        new Promise((resolve, reject) => {
          const callbackName = `__bili_jsonp_${Date.now()}_${Math.floor(Math.random() * 1e6)}`;
          const joiner = url.includes("?") ? "&" : "?";
          const script = document.createElement("script");
          let timer = null;

          const cleanup = () => {
            if (timer) clearTimeout(timer);
            delete window[callbackName];
            script.remove();
          };

          window[callbackName] = (payload) => {
            cleanup();
            resolve(payload);
          };

          script.onerror = () => {
            cleanup();
            reject(new Error("JSONP network error"));
          };

          timer = setTimeout(() => {
            cleanup();
            reject(new Error("JSONP timeout"));
          }, timeoutMs);

          script.src = `${url}${joiner}jsonp=jsonp&callback=${callbackName}`;
          document.head.appendChild(script);
        });

      const ensureAdminAccess = async () => {
        if (!ADMIN_KEY_HASH) {
          isAdmin = true;
          openBtn.hidden = false;
          return;
        }

        if (sessionStorage.getItem(ADMIN_AUTH_SESSION_KEY) === "1") {
          isAdmin = true;
          openBtn.hidden = false;
          return;
        }

        const candidates = parseAdminKeyCandidates();
        for (const key of candidates) {
          try {
            const hash = await sha256Hex(key);
            if (hash === ADMIN_KEY_HASH) {
              sessionStorage.setItem(ADMIN_AUTH_SESSION_KEY, "1");
              clearAdminKeyFromUrl();
              isAdmin = true;
              openBtn.hidden = false;
              return;
            }
          } catch {
            // ignore hash errors
          }
        }

        isAdmin = false;
        openBtn.hidden = true;
        modal.hidden = true;
      };

      const readCustom = () => {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed)) return [];
          return parsed.filter((x) =>
            x &&
            (x.section === "must" || x.section === "kilo") &&
            typeof x.url === "string" &&
            typeof x.title === "string"
          );
        } catch {
          return [];
        }
      };

      const writeCustom = (items) => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
      };

      const createCard = (item) => {
        const a = document.createElement("a");
        a.className = "rec rec-custom";
        a.dataset.source = "custom";
        a.dataset.section = item.section;
        a.dataset.recKey = item.id;
        a.href = item.url;
        a.target = "_blank";
        a.rel = "noreferrer";

        const t = document.createElement("div");
        t.className = "t";
        t.textContent = item.title;
        a.appendChild(t);

        if (item.cover) {
          const img = document.createElement("img");
          img.className = "cover";
          img.src = item.cover;
          img.alt = "";
          img.loading = "lazy";
          img.referrerPolicy = "no-referrer";
          a.appendChild(img);
        }

        const d = document.createElement("div");
        d.className = "d";
        d.textContent = item.reason || "";
        a.appendChild(d);

        return a;
      };

      const setCardLinksEnabled = (enabled) => {
        document.querySelectorAll("a.rec-static, a.rec-custom").forEach((card) => {
          const anchor = card;
          if (!(anchor instanceof HTMLAnchorElement)) return;

          if (enabled) {
            const saved = anchor.dataset.hrefSaved;
            if (saved && !anchor.hasAttribute("href")) {
              anchor.setAttribute("href", saved);
            }
            anchor.removeAttribute("aria-disabled");
            return;
          }

          if (anchor.hasAttribute("href")) {
            anchor.dataset.hrefSaved = anchor.getAttribute("href") || "";
          }
          anchor.removeAttribute("href");
          anchor.setAttribute("aria-disabled", "true");
        });
      };

      const applyHiddenStatic = () => {
        const hidden = new Set(readHiddenStatic());
        document.querySelectorAll(".rec-static").forEach((card) => {
          const key = card.getAttribute("data-rec-key") || "";
          card.hidden = hidden.has(key);
        });
      };

      const updateEmptyState = () => {
        const mustVisible = mustGrid.querySelectorAll(".rec:not(.rec-add-slot):not([hidden])").length > 0;
        const kiloVisible = kiloGrid.querySelectorAll(".rec:not(.rec-add-slot):not([hidden])").length > 0;

        if (mustEmpty) mustEmpty.hidden = mustVisible;
        if (kiloEmpty) kiloEmpty.hidden = kiloVisible;
      };

      const renderCustomCards = () => {
        document.querySelectorAll(".rec-custom").forEach((x) => x.remove());

        const items = readCustom();
        const mustItems = items.filter((x) => x.section === "must").reverse();
        const kiloItems = items.filter((x) => x.section === "kilo").reverse();

        mustItems.forEach((item) => mustGrid.prepend(createCard(item)));
        kiloItems.forEach((item) => kiloGrid.prepend(createCard(item)));
        if (editMode) setCardLinksEnabled(false);
        updateEmptyState();
      };

      const removeDeleteButtons = () => {
        document.querySelectorAll(".rec-delete").forEach((x) => x.remove());
      };

      const deleteCard = (card) => {
        const title = card.querySelector(".t")?.textContent?.trim() || "è¯¥æ¡ç›®";
        if (!confirm(`ç¡®å®šåˆ é™¤ã€Œ${title}ã€å—ï¼Ÿ`)) return;

        const source = card.getAttribute("data-source");
        const recKey = card.getAttribute("data-rec-key") || "";
        if (source === "custom") {
          const next = readCustom().filter((x) => x.id !== recKey);
          writeCustom(next);
        } else if (source === "static" && recKey) {
          const hidden = readHiddenStatic();
          if (!hidden.includes(recKey)) {
            hidden.push(recKey);
            writeHiddenStatic(hidden);
          }
        }

        applyHiddenStatic();
        renderCustomCards();
        renderEditOverlays();
      };

      const renderDeleteButtons = () => {
        removeDeleteButtons();
        if (!isAdmin || !editMode) return;

        document.querySelectorAll(".rec-static, .rec-custom").forEach((card) => {
          if (card.hidden) return;

          const del = document.createElement("button");
          del.type = "button";
          del.className = "rec-delete";
          del.textContent = "Ã—";
          del.setAttribute("aria-label", "åˆ é™¤æ¡ç›®");
          del.addEventListener("click", (event) => {
            event.preventDefault();
            event.stopPropagation();
            deleteCard(card);
          });
          card.appendChild(del);
        });
      };

      const renderAddSlots = () => {
        document.querySelectorAll(".rec-add-slot").forEach((x) => x.remove());
        if (!isAdmin || !editMode) return;

        const sections = [
          { key: "must", grid: mustGrid },
          { key: "kilo", grid: kiloGrid },
        ];

        for (const section of sections) {
          const visibleCount = section.grid.querySelectorAll(".rec:not(.rec-add-slot):not([hidden])").length;
          const slots = Math.max(0, 6 - visibleCount);

          for (let i = 0; i < slots; i += 1) {
            const add = document.createElement("button");
            add.type = "button";
            add.className = "rec rec-add-slot";
            add.setAttribute("data-section", section.key);
            add.innerHTML = '<span class="plus">+</span>';
            add.addEventListener("click", () => openCreateModal(section.key));
            section.grid.appendChild(add);
          }
        }
      };

      const renderEditOverlays = () => {
        renderDeleteButtons();
        renderAddSlots();
        updateEmptyState();
      };

      const resetForm = (section = "must") => {
        linkInput.value = "";
        sectionInput.value = section;
        titleInput.value = "";
        coverInput.value = "";
        reasonInput.value = "";
        coverPreview.hidden = true;
        coverPreview.removeAttribute("src");
        showStatus("");
      };

      const openModal = () => {
        if (!isAdmin || !editMode) return;
        modal.hidden = false;
      };

      const closeModal = () => {
        modal.hidden = true;
        resetForm(sectionInput.value === "kilo" ? "kilo" : "must");
      };

      const openCreateModal = (section) => {
        resetForm(section);
        openModal();
      };

      const syncCoverPreview = () => {
        const src = normalizeCover(coverInput.value);
        if (!src) {
          coverPreview.hidden = true;
          coverPreview.removeAttribute("src");
          return;
        }
        coverPreview.src = src;
        coverPreview.hidden = false;
      };

      const fetchMeta = async () => {
        if (!isAdmin) return;
        const link = normalizeUrl(linkInput.value);
        const id = parseVideoId(link);

        if (!id) {
          showStatus("é“¾æ¥é‡Œæ²¡è¯†åˆ«åˆ° BV/av å·ã€‚", true);
          return;
        }

        showStatus("æ­£åœ¨æŠ“å–æ ‡é¢˜å’Œå°é¢...");
        const applyMetaFromPayload = (json) => {
          if (!json || json.code !== 0 || !json.data) {
            throw new Error(json?.message || "Bç«™æ¥å£è¿”å›å¼‚å¸¸");
          }
          titleInput.value = json.data.title || "";
          coverInput.value = normalizeCover(json.data.pic || "");
          syncCoverPreview();
        };

        try {
          const qs = new URLSearchParams(id).toString();
          const apiUrl = `${VIEW_API}?${qs}`;

          try {
            const resp = await fetch(apiUrl);
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            const json = await resp.json();
            applyMetaFromPayload(json);
            showStatus("å·²è‡ªåŠ¨å¡«å¥½æ ‡é¢˜å’Œå°é¢ã€‚");
            return;
          } catch {
            const jsonpPayload = await fetchViaJsonp(apiUrl);
            applyMetaFromPayload(jsonpPayload);
            showStatus("å·²é€šè¿‡å…¼å®¹æ¨¡å¼æŠ“å–æ ‡é¢˜å’Œå°é¢ã€‚");
          }
        } catch (err) {
          const msg = err instanceof Error ? err.message : String(err);
          showStatus(`æŠ“å–å¤±è´¥ï¼š${msg}ã€‚è¿™æ˜¯è·¨åŸŸ/é£æ§å¸¸è§é—®é¢˜ï¼Œå¯æ‰‹åŠ¨å¡«æ ‡é¢˜å’Œå°é¢ã€‚`, true);
        }
      };

      const saveEntry = () => {
        if (!isAdmin) return;
        const item = {
          id: (globalThis.crypto?.randomUUID?.() || `${Date.now()}-${Math.random()}`).toString(),
          section: sectionInput.value === "kilo" ? "kilo" : "must",
          url: normalizeUrl(linkInput.value),
          title: normalizeUrl(titleInput.value),
          cover: normalizeCover(coverInput.value),
          reason: normalizeUrl(reasonInput.value),
          createdAt: new Date().toISOString(),
        };

        if (!item.url) {
          showStatus("è¯·å…ˆè¾“å…¥è§†é¢‘é“¾æ¥ã€‚", true);
          return;
        }
        if (!item.title) {
          showStatus("è¯·å…ˆæŠ“å–æˆ–å¡«å†™æ ‡é¢˜ã€‚", true);
          return;
        }

        const next = [item, ...readCustom()].slice(0, 60);
        writeCustom(next);
        applyHiddenStatic();
        renderCustomCards();
        closeModal();
        renderEditOverlays();
      };

      const setEditMode = (next) => {
        if (!isAdmin) return;
        editMode = next;
        openBtn.textContent = editMode ? "å®Œæˆ" : "ç¼–è¾‘";
        if (editMode) {
          setCardLinksEnabled(false);
          renderEditOverlays();
          return;
        }
        closeModal();
        removeDeleteButtons();
        document.querySelectorAll(".rec-add-slot").forEach((x) => x.remove());
        setCardLinksEnabled(true);
        updateEmptyState();
      };

      openBtn.addEventListener("click", () => setEditMode(!editMode));
      closeBtn.addEventListener("click", closeModal);
      cancelBtn.addEventListener("click", closeModal);
      fetchBtn.addEventListener("click", fetchMeta);
      saveBtn.addEventListener("click", saveEntry);
      coverInput.addEventListener("input", syncCoverPreview);
      linkInput.addEventListener("change", () => {
        if (normalizeUrl(linkInput.value)) fetchMeta();
      });

      window.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && !modal.hidden) closeModal();
      });

      modal.addEventListener("click", (event) => {
        if (event.target === modal) closeModal();
      });

      (async () => {
        await ensureAdminAccess();
        applyHiddenStatic();
        renderCustomCards();
        renderEditOverlays();
      })();
    })();
  </script>

  <style lang="scss">
  @use "../styles/mixins" as m;

  .rec{
    @include m.glass;
    @include m.hover-float;
    border-radius: var(--r-lg);
    padding: 14px 14px;
    display: block;
    position: relative;
  }
  .cover{
    width: 100%;
    aspect-ratio: 16 / 9;
    object-fit: cover;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.14);
    margin: 8px 0 10px;
    display: block;
  }
  .t{ font-weight: 700; margin-bottom: 6px; }
  .d{ color: rgba(255,255,255,.65); font-size: 13px; min-height: 34px; }

  .intro-grid{
    align-items: stretch;
  }
  .intro-card{
    @include m.glass;
    border-radius: var(--r-lg);
    padding: 14px 14px;
  }
  .intro-top{
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
  }
  .intro-avatar{
    width: 38px;
    height: 38px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid rgba(255,255,255,.18);
    display: block;
  }
  .intro-name{
    font-size: 16px;
    font-weight: 700;
    letter-spacing: .2px;
  }
  .intro-snippet{
    margin: 0;
    color: rgba(255,255,255,.78);
    font-size: 14px;
    line-height: 1.55;
  }
  .intro-links{
    margin-top: 12px;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .intro-link{
    padding: 5px 10px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.15);
    background: rgba(0,0,0,.24);
    color: rgba(230,255,244,.95);
    font-size: 12px;
    text-decoration: none;
    transition: border-color var(--dur) var(--ease), background var(--dur) var(--ease), transform var(--dur) var(--ease);
  }
  .intro-link:hover{
    border-color: rgba(160, 225, 196, .6);
    background: rgba(30, 60, 52, .42);
    transform: translateY(-1px);
  }
  .intro-note{
    margin-top: 10px;
  }

  :global(a.rec-custom){
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    box-shadow: var(--glass-shadow);
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    border-radius: var(--r-lg);
    padding: 14px;
    display: block;
    position: relative;
    transition:
      transform var(--dur) var(--ease),
      box-shadow var(--dur) var(--ease),
      border-color var(--dur) var(--ease),
      background var(--dur) var(--ease);
  }
  :global(a.rec-custom:hover){
    transform: translateY(-4px);
    border-color: rgba(255,255,255,.16);
    box-shadow: 0 24px 70px rgba(0,0,0,.46);
  }
  :global(.rec-custom .cover){
    width: 100%;
    aspect-ratio: 16 / 9;
    object-fit: cover;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.14);
    margin: 8px 0 10px;
    display: block;
  }
  :global(.rec-custom .t){
    font-weight: 700;
    margin-bottom: 6px;
  }
  :global(.rec-custom .d){
    color: rgba(255,255,255,.65);
    font-size: 13px;
    min-height: 34px;
  }

  :global(.rec-delete){
    position: absolute;
    top: 10px;
    right: 10px;
    width: 28px;
    height: 28px;
    border-radius: 999px;
    border: 1px solid rgba(255, 120, 120, .45);
    background: rgba(28, 10, 14, .72);
    color: rgba(255, 214, 214, .95);
    font-size: 18px;
    line-height: 1;
    cursor: pointer;
    z-index: 3;
    display: grid;
    place-items: center;
    transition: transform var(--dur) var(--ease), border-color var(--dur) var(--ease), background var(--dur) var(--ease);
  }
  :global(.rec-delete:hover){
    transform: scale(1.04);
    border-color: rgba(255, 142, 142, .75);
    background: rgba(60, 14, 22, .86);
  }

  :global(button.rec-add-slot){
    appearance: none;
    border-radius: var(--r-lg);
    border: 1px dashed rgba(255,255,255,.28);
    background:
      linear-gradient(160deg, rgba(18, 22, 38, .62), rgba(12, 15, 26, .48));
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.05);
    min-height: 250px;
    width: 100%;
    display: grid;
    place-items: center;
    cursor: pointer;
    transition:
      transform var(--dur) var(--ease),
      border-color var(--dur) var(--ease),
      background var(--dur) var(--ease);
  }
  :global(button.rec-add-slot:hover){
    transform: translateY(-3px);
    border-color: rgba(160, 225, 196, .55);
    background:
      linear-gradient(160deg, rgba(28, 40, 55, .7), rgba(18, 26, 38, .6));
  }
  :global(button.rec-add-slot .plus){
    width: 54px;
    height: 54px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.24);
    background: rgba(255,255,255,.07);
    color: rgba(230,255,244,.96);
    font-size: 30px;
    line-height: 1;
    display: grid;
    place-items: center;
  }

  .admin-bar{
    display: flex;
    justify-content: flex-end;
    margin-bottom: 10px;
  }
  .admin-btn{
    border: 1px solid rgba(255,255,255,.16);
    border-radius: 999px;
    background: rgba(20,20,30,.5);
    color: rgba(255,255,255,.9);
    padding: 6px 12px;
    font-size: 13px;
    cursor: pointer;
    transition: border-color var(--dur) var(--ease), background var(--dur) var(--ease);
  }
  .admin-btn[hidden]{
    display: none !important;
  }
  .admin-btn:hover{
    border-color: rgba(255,255,255,.32);
    background: rgba(40,40,60,.64);
  }
  .admin-btn.primary{
    background: rgba(74, 206, 148, .2);
    border-color: rgba(74, 206, 148, .5);
    color: rgba(224,255,241,.98);
  }

  .admin-modal{
    position: fixed;
    inset: 0;
    z-index: 80;
    display: grid;
    place-items: center;
    background: rgba(0,0,0,.56);
    padding: 16px;
  }
  .admin-modal[hidden]{
    display: none !important;
  }
  .admin-panel{
    width: min(760px, 100%);
    max-height: min(86vh, 900px);
    overflow: auto;
    border-radius: 20px;
    padding: 16px;
    @include m.glass;
  }
  .admin-head{
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }
  .admin-head h3{
    margin: 0;
    font-size: 18px;
  }
  .admin-close{
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 1px solid rgba(255,255,255,.2);
    background: rgba(0,0,0,.3);
    color: rgba(255,255,255,.9);
    cursor: pointer;
  }
  .admin-grid{
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .field{
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .field.full{ grid-column: 1 / -1; }
  .field span{
    font-size: 12px;
    color: rgba(255,255,255,.78);
  }
  .field input,
  .field textarea,
  .field select{
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,.16);
    background: rgba(0,0,0,.34);
    color: rgba(255,255,255,.92);
    padding: 10px;
    font-size: 14px;
    font-family: inherit;
  }
  .field select:disabled{
    opacity: .8;
    cursor: not-allowed;
  }
  .field textarea{
    resize: vertical;
    min-height: 76px;
  }
  .field.actions{
    justify-content: flex-end;
  }
  .cover-preview{
    width: 100%;
    max-width: 320px;
    aspect-ratio: 16 / 9;
    object-fit: cover;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.2);
  }
  .admin-status{
    min-height: 20px;
    margin: 12px 0 0;
    color: rgba(255,255,255,.86);
    font-size: 13px;
  }
  .admin-status.err{
    color: rgb(255 171 171);
  }
  .admin-actions{
    display: flex;
    gap: 8px;
    margin-top: 8px;
  }

  @media (max-width: 720px){
    .admin-grid{
      grid-template-columns: 1fr;
    }
  }
  </style>
</BaseLayout>
