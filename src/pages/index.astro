---
import BaseLayout from "../layouts/BaseLayout.astro";
import NavBar from "../components/NavBar.astro";
import Hero from "../components/Hero.astro";
import Section from "../components/Section.astro";
import TagPills from "../components/TagPills.astro";

import { getCollection } from "astro:content";

const clips = await getCollection("clips");
const fanworks = await getCollection("fanworks");
const latestRecs = [...clips, ...fanworks]
  .sort((a, b) => (b.data.createdAt ?? "").localeCompare(a.data.createdAt ?? ""))
  .slice(0, 6);
---

<BaseLayout title="闪耀舞台" description="入坑导航、日程表、直播记录、精选与数据">
  <NavBar slot="nav" active="home" />

  <Hero
    title="闪耀舞台 · 粉丝导航站"
    tagline="给新粉一条最短入坑路径，信息入口：日程表、直播记录、粉丝数据、精选内容。"
  />

  <Section title="本周日程">
    <div id="home-schedule-list"></div>
    <p class="p" id="home-schedule-empty" hidden>暂无已保存日程。</p>
  </Section>

  <Section title="最新推荐">
    <div class="grid cols-3">
      {latestRecs.map((r) => (
        <a class="rec" href={r.data.url} target="_blank" rel="noreferrer" data-member={r.data.member} data-tags={r.data.tags.join(",")}>
          <div class="rt">{r.data.title}</div>
          <div class="rd">{r.data.reason ?? ""}</div>
          <div class="meta">
            <span class="pill">{r.data.member}</span>
            <span class="pill faint">{r.collection}</span>
          </div>
          <TagPills tags={r.data.tags.slice(0, 3)} />
        </a>
      ))}
    </div>
  </Section>

  <script is:inline>
    (() => {
      const contentKey = "schedule.manual.entries.v3";
      const listEl = document.getElementById("home-schedule-list");
      const emptyEl = document.getElementById("home-schedule-empty");
      if (!listEl || !emptyEl) return;

      const roomLabelMap = {
        fiona: "心宜",
        gladys: "思诺",
      };

      const formatDateCN = (date) => {
        const m = String(date || "").match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (!m) return date || "--";
        return `${Number(m[1])}年${Number(m[2])}月${Number(m[3])}日`;
      };

      const sortEntries = (entries) =>
        [...entries].sort((a, b) => `${a.date}T${a.time}`.localeCompare(`${b.date}T${b.time}`));

      const pickUpcoming = (entries) => {
        const now = Date.now();
        const upcoming = entries.filter((entry) => {
          const ts = new Date(`${entry.date}T${entry.time}:00`).getTime();
          return Number.isFinite(ts) && ts >= now;
        });
        return (upcoming.length ? upcoming : entries).slice(0, 3);
      };

      const createRow = (entry) => {
        const row = document.createElement("div");
        row.className = "row";

        const when = document.createElement("div");
        when.className = "when";
        when.textContent = `${formatDateCN(entry.date)} ${entry.time}`;

        const what = document.createElement("div");
        what.className = "what";
        const title = document.createElement("div");
        title.className = "t";
        title.textContent = entry.title || "未命名日程";
        const meta = document.createElement("div");
        meta.className = "m";
        const room = document.createElement("span");
        room.className = "pill";
        room.textContent = `直播间：${roomLabelMap[entry.room] || entry.room || "--"}`;
        meta.appendChild(room);
        what.append(title, meta);

        const go = document.createElement("div");
        go.className = "go";
        const link = document.createElement("a");
        link.className = "link";
        link.href = "/schedule";
        link.textContent = "查看";
        go.appendChild(link);

        row.append(when, what, go);
        return row;
      };

      const render = (entries) => {
        listEl.innerHTML = "";
        if (!entries.length) {
          emptyEl.hidden = false;
          return;
        }
        emptyEl.hidden = true;
        entries.forEach((entry) => listEl.appendChild(createRow(entry)));
      };

      const load = async () => {
        try {
          const response = await fetch(`/api/content/${encodeURIComponent(contentKey)}`, { cache: "no-store" });
          const json = await response.json();
          if (!response.ok || !json?.ok || !Array.isArray(json.data)) {
            render([]);
            return;
          }

          const normalized = json.data.filter((entry) => {
            if (!entry || typeof entry !== "object") return false;
            if (typeof entry.title !== "string") return false;
            if (typeof entry.date !== "string") return false;
            if (typeof entry.time !== "string") return false;
            if (entry.room !== "fiona" && entry.room !== "gladys") return false;
            return true;
          });

          render(pickUpcoming(sortEntries(normalized)));
        } catch {
          render([]);
        }
      };

      load();
    })();
  </script>

  <style lang="scss">
  @use "../styles/mixins" as m;

  #home-schedule-list{
    display: grid;
    gap: 10px;
  }

  .row{
    @include m.glass;
    border-radius: var(--r-lg);
    padding: 12px 12px;
    display: grid;
    grid-template-columns: 180px 1fr 64px;
    gap: 12px;
    align-items: center;
  }
  .when{ font-size: 13px; color: rgba(255,255,255,.70); }
  .what{ min-width: 0; }
  .t{ font-weight: 700; }
  .m{ display:flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; }
  .pill{
    padding: 4px 8px;
    border-radius: 999px;
    font-size: 12px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.18);
    color: rgba(255,255,255,.78);
  }
  .pill.faint{ color: rgba(255,255,255,.62); }
  .muted{ color: rgba(255,255,255,.55); font-size: 12px; }
  .link{
    font-size: 12px;
    padding: 7px 10px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.14);
  }
  .link:hover{ background: rgba(0,0,0,.22); }

  .rec{
    @include m.glass;
    @include m.hover-float;
    border-radius: var(--r-lg);
    padding: 14px 14px;
    display: block;
  }
  .rt{ font-weight: 700; margin-bottom: 6px; }
  .rd{ color: rgba(255,255,255,.65); font-size: 13px; min-height: 34px; }
  .meta{ display:flex; gap: 8px; flex-wrap: wrap; margin: 10px 0 8px; }

  @media (max-width: 860px){
    .row{
      grid-template-columns: 1fr;
    }
  }
  </style>
</BaseLayout>

<style lang="scss">
:global(.page){
  background: transparent !important;
  border: 0 !important;
  box-shadow: none !important;
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
  padding: 0 !important;
}
</style>
