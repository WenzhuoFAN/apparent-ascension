---
import BaseLayout from "../layouts/BaseLayout.astro";
import NavBar from "../components/NavBar.astro";
import Hero from "../components/Hero.astro";
import Section from "../components/Section.astro";
import Card from "../components/Card.astro";
import TagPills from "../components/TagPills.astro";

import { getCollection } from "astro:content";
import { formatDateTimeCN } from "../utils/date";

const scheduleEntries = await getCollection("schedule");
const schedules = scheduleEntries
  .map((e) => ({ ...e.data, slug: e.slug }))
  .sort((a, b) => a.weekStart.localeCompare(b.weekStart));

const scheduleItems = schedules.flatMap((w) =>
  w.items.map((it) => ({
    ...it,
    weekStart: w.weekStart,
  }))
).sort((a, b) => new Date(a.startAt).getTime() - new Date(b.startAt).getTime());

const upcoming = scheduleItems.slice(0, 3);

const clips = await getCollection("clips");
const fanworks = await getCollection("fanworks");
const latestRecs = [...clips, ...fanworks]
  .sort((a, b) => (b.data.createdAt ?? "").localeCompare(a.data.createdAt ?? ""))
  .slice(0, 6);
---

<BaseLayout title="Èó™ËÄÄËàûÂè∞ÔΩúÈùûÂÆòÊñπÁ≤â‰∏ùÁ´ô" description="ÂÖ•ÂùëÂØºËà™ÔΩúÊéíÁè≠ÔΩúÁõ¥Êí≠ËÆ∞ÂΩïÔΩúÊï∞ÊçÆÔΩúÁ≤æÈÄâ‰∫åÂàõ/ÂàáÁâá">
  <NavBar slot="nav" active="home" />

  <Hero
    title="Èó™ËÄÄËàûÂè∞ ¬∑ Á≤â‰∏ùÂØºËà™Á´ô"
    tagline="ÁªôÊñ∞Á≤â‰∏ÄÊù°ÊúÄÁü≠ÁöÑÂÖ•ÂùëË∑ØÔºå‰πüÁªôËÄÅÁ≤â‰∏Ä‰∏™ÊØèÂë®ÂøÖÁúãÁöÑ‰ø°ÊÅØÂÖ•Âè£ÔºöÊéíÁè≠„ÄÅÁõ¥Êí≠ËÆ∞ÂΩï„ÄÅÊï∞ÊçÆÊàêÈïø„ÄÅÁ≤æÈÄâ‰∫åÂàõ/ÂàáÁâá„ÄÇ"
    note="ÊèêÁ§∫ÔºöÊää‰Ω†ÁöÑËÉåÊôØÊµ∑Êä•ÊîæÂà∞ public/hero/poster.jpgÔºàÊàñÂú® styles/_tokens.scss ÈáåÊîπË∑ØÂæÑÔºâ„ÄÇ"
  />

  <Section title="Âø´ÈÄüÂÖ•Âè£" subtitle="ÂÖàÊääÈ™®Êû∂Êê≠Á®≥ÔºåÂêéÈù¢ÂÖ®ÊòØÂ°´ÂÜÖÂÆπ„ÄÇ">
    <div class="grid cols-3">
      <Card href="/start" title="ÂÖ•ÂùëÂØºËà™" desc="Êñ∞Á≤â 3 Ê≠•Ë∑ØÁ∫øÔºöÂÖàÁúã‰ªÄ‰πà„ÄÅÂÜçÁúã‰ªÄ‰πà„ÄÅË°•ËØæÊ∏ÖÂçï„ÄÇ" icon="üß≠" />
      <Card href="/schedule" title="Êú¨Âë®ÊéíÁè≠" desc="‰∏ÄÁúºÁúãÊáÇÊú¨Âë®/‰∏ãÂë®Áõ¥Êí≠ÂÆâÊéí„ÄÇ" icon="üóìÔ∏è" />
      <Card href="/library" title="Á≤æÈÄâÂ∫ì" desc="‰ºòÁßÄ‰∫åÂàõ / ÂàáÁâá / ÂõûÊîæÊé®ËçêÔºåÂ∏¶Ê†áÁ≠æÁ≠õÈÄâ„ÄÇ" icon="‚ú®" />
      <Card href="/streams" title="Áõ¥Êí≠ËÆ∞ÂΩï" desc="ÊØèÂú∫Áõ¥Êí≠Ôºö‰∫ÆÁÇπÊëòË¶Å„ÄÅÂõûÊîæÈìæÊé•„ÄÅÂÖ≥ËÅîÂàáÁâá„ÄÇ" icon="üìº" />
      <Card href="/stats" title="Êï∞ÊçÆ" desc="Á≤â‰∏ùÊï∞‰∏éÊàêÈïøËÆ∞ÂΩïÔºàÂÖàÊâãÂä®Âø´ÁÖßÔºåÂêéÁª≠ÂÜçËá™Âä®ÂåñÔºâ„ÄÇ" icon="üìà" />
      <Card href="/members/fiona" title="ÊàêÂëòÈ°µ" desc="ÂøÉÂÆú / ÊÄùËØ∫Ôºö‰∫∫ËÆæÂÖ≥ÈîÆËØç„ÄÅËßÇÁúãÊé®Ëçê„ÄÅÂ∏∏Áî®ÈìæÊé•„ÄÇ" icon="ü´ß" />
    </div>
  </Section>

  <Section title="ÊéíÁè≠È¢ÑËßà" subtitle="ÔºàÁ§∫‰æãÔºâÊòæÁ§∫ÊúÄËøë 3 Âú∫„ÄÇ‰Ω†ÊØèÂë®Êñ∞Â¢û‰∏Ä‰∏™ schedule Êñá‰ª∂Â∞±Ë°å„ÄÇ">
    {upcoming.length ? (
      <div class="grid">
        {upcoming.map((it) => (
          <div class="row">
            <div class="when">{formatDateTimeCN(it.startAt)}</div>
            <div class="what">
              <div class="t">{it.title}</div>
              <div class="m">
                <span class="pill">{it.member}</span>
                {it.type && <span class="pill faint">{it.type}</span>}
                <span class="pill faint">week {it.weekStart}</span>
              </div>
            </div>
            <div class="go">
              {it.link ? (
                <a class="link" href={it.link} target="_blank" rel="noreferrer">ÈìæÊé•</a>
              ) : (
                <span class="muted">ÂæÖË°•</span>
              )}
            </div>
          </div>
        ))}
      </div>
    ) : (
      <p class="p">ËøòÊ≤°ÊúâÊéíÁè≠Êï∞ÊçÆ„ÄÇÂéª src/content/schedule Êñ∞Âª∫‰∏Ä‰∏™Êñá‰ª∂ÂêßÔΩû</p>
    )}
  </Section>

  <Section title="ÊúÄÊñ∞Êé®Ëçê" subtitle="ÔºàÁ§∫‰æãÔºâ‰ªéÂàáÁâá+‰∫åÂàõÈáåÊåâ createdAt ÂèñÊúÄÊñ∞ 6 Êù°„ÄÇ">
    <div class="grid cols-3">
      {latestRecs.map((r) => (
        <a class="rec" href={r.data.url} target="_blank" rel="noreferrer" data-member={r.data.member} data-tags={r.data.tags.join(",")}>
          <div class="rt">{r.data.title}</div>
          <div class="rd">{r.data.reason ?? ""}</div>
          <div class="meta">
            <span class="pill">{r.data.member}</span>
            <span class="pill faint">{r.collection}</span>
          </div>
          <TagPills tags={r.data.tags.slice(0, 3)} />
        </a>
      ))}
    </div>
  </Section>

  <style lang="scss">
  @use "../styles/mixins" as m;

  .row{
    @include m.glass;
    border-radius: var(--r-lg);
    padding: 12px 12px;
    display: grid;
    grid-template-columns: 180px 1fr 64px;
    gap: 12px;
    align-items: center;
  }
  .when{ font-size: 13px; color: rgba(255,255,255,.70); }
  .t{ font-weight: 700; }
  .m{ display:flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; }
  .pill{
    padding: 4px 8px;
    border-radius: 999px;
    font-size: 12px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.18);
    color: rgba(255,255,255,.78);
  }
  .pill.faint{ color: rgba(255,255,255,.62); }
  .muted{ color: rgba(255,255,255,.55); font-size: 12px; }
  .link{
    font-size: 12px;
    padding: 7px 10px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.14);
  }
  .link:hover{ background: rgba(0,0,0,.22); }

  .rec{
    @include m.glass;
    @include m.hover-float;
    border-radius: var(--r-lg);
    padding: 14px 14px;
    display: block;
  }
  .rt{ font-weight: 700; margin-bottom: 6px; }
  .rd{ color: rgba(255,255,255,.65); font-size: 13px; min-height: 34px; }
  .meta{ display:flex; gap: 8px; flex-wrap: wrap; margin: 10px 0 8px; }
  </style>
</BaseLayout>

<style lang="scss">
:global(.page){
  background: transparent !important;
  border: 0 !important;
  box-shadow: none !important;
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
  padding: 0 !important;
}
</style>