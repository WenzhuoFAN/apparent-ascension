---
import BaseLayout from "../layouts/BaseLayout.astro";
import NavBar from "../components/NavBar.astro";
import Hero from "../components/Hero.astro";
import Section from "../components/Section.astro";
import TagPills from "../components/TagPills.astro";

import { getCollection } from "astro:content";
import { formatDateTimeCN } from "../utils/date";

const scheduleEntries = await getCollection("schedule");
const schedules = scheduleEntries
  .map((e) => ({ ...e.data, slug: e.slug }))
  .sort((a, b) => a.weekStart.localeCompare(b.weekStart));

const scheduleItems = schedules.flatMap((w) =>
  w.items.map((it) => ({
    ...it,
    weekStart: w.weekStart,
  }))
).sort((a, b) => new Date(a.startAt).getTime() - new Date(b.startAt).getTime());

const upcoming = scheduleItems.slice(0, 3);

const clips = await getCollection("clips");
const fanworks = await getCollection("fanworks");
const latestRecs = [...clips, ...fanworks]
  .sort((a, b) => (b.data.createdAt ?? "").localeCompare(a.data.createdAt ?? ""))
  .slice(0, 6);
---

<BaseLayout title="闪耀舞台｜非官方粉丝站" description="入坑导航｜日程表｜直播记录｜数据｜精选二创/切片">
  <NavBar slot="nav" active="home" />

  <Hero
    title="闪耀舞台 · 粉丝导航站"
    tagline="给新粉一条最短的入坑路，也给老粉一个每周必看的信息入口：日程表、直播记录、数据成长、精选二创/切片。"
  />

  <Section title="本周日程">
    {upcoming.length ? (
      <div class="grid">
        {upcoming.map((it) => (
          <div class="row">
            <div class="when">{formatDateTimeCN(it.startAt)}</div>
            <div class="what">
              <div class="t">{it.title}</div>
              <div class="m">
                <span class="pill">{it.member}</span>
                {it.type && <span class="pill faint">{it.type}</span>}
                <span class="pill faint">week {it.weekStart}</span>
              </div>
            </div>
            <div class="go">
              {it.link ? (
                <a class="link" href={it.link} target="_blank" rel="noreferrer">链接</a>
              ) : (
                <span class="muted">待补</span>
              )}
            </div>
          </div>
        ))}
      </div>
    ) : (
      <p class="p">还没有日程表数据。去 src/content/schedule 新建一个文件吧～</p>
    )}
  </Section>

  <Section title="最新推荐">
    <div class="grid cols-3">
      {latestRecs.map((r) => (
        <a class="rec" href={r.data.url} target="_blank" rel="noreferrer" data-member={r.data.member} data-tags={r.data.tags.join(",")}>
          <div class="rt">{r.data.title}</div>
          <div class="rd">{r.data.reason ?? ""}</div>
          <div class="meta">
            <span class="pill">{r.data.member}</span>
            <span class="pill faint">{r.collection}</span>
          </div>
          <TagPills tags={r.data.tags.slice(0, 3)} />
        </a>
      ))}
    </div>
  </Section>

  <style lang="scss">
  @use "../styles/mixins" as m;

  .row{
    @include m.glass;
    border-radius: var(--r-lg);
    padding: 12px 12px;
    display: grid;
    grid-template-columns: 180px 1fr 64px;
    gap: 12px;
    align-items: center;
  }
  .when{ font-size: 13px; color: rgba(255,255,255,.70); }
  .t{ font-weight: 700; }
  .m{ display:flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; }
  .pill{
    padding: 4px 8px;
    border-radius: 999px;
    font-size: 12px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.18);
    color: rgba(255,255,255,.78);
  }
  .pill.faint{ color: rgba(255,255,255,.62); }
  .muted{ color: rgba(255,255,255,.55); font-size: 12px; }
  .link{
    font-size: 12px;
    padding: 7px 10px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.14);
  }
  .link:hover{ background: rgba(0,0,0,.22); }

  .rec{
    @include m.glass;
    @include m.hover-float;
    border-radius: var(--r-lg);
    padding: 14px 14px;
    display: block;
  }
  .rt{ font-weight: 700; margin-bottom: 6px; }
  .rd{ color: rgba(255,255,255,.65); font-size: 13px; min-height: 34px; }
  .meta{ display:flex; gap: 8px; flex-wrap: wrap; margin: 10px 0 8px; }
  </style>
</BaseLayout>

<style lang="scss">
:global(.page){
  background: transparent !important;
  border: 0 !important;
  box-shadow: none !important;
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
  padding: 0 !important;
}
</style>
