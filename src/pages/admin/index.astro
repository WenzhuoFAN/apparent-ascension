---
import BaseLayout from "../../layouts/BaseLayout.astro";
import NavBar from "../../components/NavBar.astro";
---
<BaseLayout title="管理后台｜闪耀舞台" description="管理员登录与会话管理">
  <NavBar slot="nav" />

  <h1 class="h1">管理后台</h1>
  <p class="p">登录后可在内容页面使用编辑功能。</p>

  <section class="panel" id="login-panel">
    <h2 class="h2">管理员登录</h2>
    <label class="field">
      <span>用户名</span>
      <input id="username-input" type="text" autocomplete="username" />
    </label>
    <label class="field">
      <span>密码</span>
      <input id="password-input" type="password" autocomplete="current-password" />
    </label>
    <div class="actions">
      <button class="btn primary" id="login-btn" type="button">登录</button>
    </div>
    <p class="status" id="login-status"></p>
  </section>

  <section class="panel" id="session-panel" hidden>
    <h2 class="h2">登录状态</h2>
    <p class="p">当前账号：<strong id="session-user">-</strong></p>
    <div class="actions">
      <a class="btn" href="/schedule">去日程表</a>
      <a class="btn" href="/start">去入坑页</a>
      <button class="btn" id="logout-btn" type="button">退出登录</button>
    </div>
    <p class="status" id="session-status"></p>
  </section>

  <script>
    (() => {
      const loginPanel = document.getElementById("login-panel");
      const sessionPanel = document.getElementById("session-panel");
      const usernameInput = document.getElementById("username-input");
      const passwordInput = document.getElementById("password-input");
      const loginBtn = document.getElementById("login-btn");
      const logoutBtn = document.getElementById("logout-btn");
      const loginStatus = document.getElementById("login-status");
      const sessionStatus = document.getElementById("session-status");
      const sessionUser = document.getElementById("session-user");

      if (!loginPanel || !sessionPanel || !usernameInput || !passwordInput || !loginBtn || !logoutBtn) return;
      if (!loginStatus || !sessionStatus || !sessionUser) return;

      const setLoginStatus = (msg, isErr = false) => {
        loginStatus.textContent = msg || "";
        loginStatus.classList.toggle("err", !!isErr);
      };
      const setSessionStatus = (msg, isErr = false) => {
        sessionStatus.textContent = msg || "";
        sessionStatus.classList.toggle("err", !!isErr);
      };

      const refreshSession = async () => {
        try {
          const response = await fetch("/api/admin/session", { cache: "no-store" });
          const json = await response.json();
          const authenticated = !!json?.authenticated;

          loginPanel.hidden = authenticated;
          sessionPanel.hidden = !authenticated;
          sessionUser.textContent = authenticated ? String(json.username || "-") : "-";
        } catch (err) {
          setLoginStatus(`会话检查失败：${err instanceof Error ? err.message : String(err)}`, true);
        }
      };

      loginBtn.addEventListener("click", async () => {
        const username = String(usernameInput.value || "").trim();
        const password = String(passwordInput.value || "");
        if (!username || !password) {
          setLoginStatus("请输入用户名和密码。", true);
          return;
        }

        setLoginStatus("登录中...");
        try {
          const response = await fetch("/api/admin/login", {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify({ username, password }),
          });
          const json = await response.json();
          if (!response.ok || !json?.ok) {
            setLoginStatus(String(json?.message || "登录失败。"), true);
            return;
          }

          passwordInput.value = "";
          setLoginStatus("");
          await refreshSession();
        } catch (err) {
          setLoginStatus(`登录失败：${err instanceof Error ? err.message : String(err)}`, true);
        }
      });

      logoutBtn.addEventListener("click", async () => {
        setSessionStatus("退出中...");
        try {
          await fetch("/api/admin/logout", { method: "POST" });
          setSessionStatus("");
          await refreshSession();
        } catch (err) {
          setSessionStatus(`退出失败：${err instanceof Error ? err.message : String(err)}`, true);
        }
      });

      refreshSession();
    })();
  </script>

  <style lang="scss">
  @use "../../styles/mixins" as m;

  .panel{
    @include m.glass;
    border-radius: var(--r-xl);
    padding: 16px;
    max-width: 560px;
    margin-bottom: 14px;
  }
  .field{
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 10px;
  }
  .field span{
    font-size: 12px;
    color: rgba(255,255,255,.75);
  }
  .field input{
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,.16);
    background: rgba(0,0,0,.34);
    color: rgba(255,255,255,.92);
    padding: 10px;
    font-size: 14px;
    font-family: inherit;
  }
  .actions{
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 6px;
  }
  .btn{
    border: 1px solid rgba(255,255,255,.16);
    border-radius: 999px;
    background: rgba(20,20,30,.5);
    color: rgba(255,255,255,.9);
    padding: 7px 12px;
    font-size: 13px;
    cursor: pointer;
  }
  .btn.primary{
    background: rgba(74, 206, 148, .18);
    border-color: rgba(74, 206, 148, .5);
    color: rgba(224,255,241,.98);
  }
  .status{
    min-height: 20px;
    margin: 8px 0 0;
    font-size: 13px;
    color: rgba(255,255,255,.74);
  }
  .status.err{
    color: #f3a3a3;
  }
  </style>
</BaseLayout>

