---
import BaseLayout from "../layouts/BaseLayout.astro";
import NavBar from "../components/NavBar.astro";
import Section from "../components/Section.astro";

import { getCollection } from "astro:content";
import { formatDateCN } from "../utils/date";

const metrics = await getCollection("metrics");
const rows = metrics
  .flatMap((m) => m.data)
  .sort((a, b) => {
    const byDate = a.date.localeCompare(b.date);
    if (byDate !== 0) return byDate;
    return (a.capturedAt ?? "").localeCompare(b.capturedAt ?? "");
  });

type StatPoint = { x: number; y: number; date: string };

function shortDate(dateStr: string) {
  const parts = dateStr.split("-");
  if (parts.length !== 3) return dateStr;
  return `${parts[1]}-${parts[2]}`;
}

function spark(points: StatPoint[], w = 520, h = 180, padLeft = 52, padRight = 16, padTop = 12, padBottom = 34) {
  if (!points.length) return "";
  const sorted = points.slice().sort((a, b) => a.x - b.x);
  const xs = sorted.map((p) => p.x);
  const ys = sorted.map((p) => p.y);
  const minX = Math.min(...xs);
  const maxX = Math.max(...xs);
  const minY = Math.min(...ys);
  const maxY = Math.max(...ys);
  const dx = maxX - minX || 1;
  const dy = maxY - minY || 1;
  const plotLeft = padLeft;
  const plotRight = w - padRight;
  const plotTop = padTop;
  const plotBottom = h - padBottom;
  const plotWidth = plotRight - plotLeft;
  const plotHeight = plotBottom - plotTop;
  const toX = (x: number) => plotLeft + ((x - minX) / dx) * plotWidth;
  const toY = (y: number) => plotBottom - ((y - minY) / dy) * plotHeight;
  const d = sorted.map((p, i) => `${i === 0 ? "M" : "L"} ${toX(p.x).toFixed(1)} ${toY(p.y).toFixed(1)}`).join(" ");
  const first = sorted[0];
  const last = sorted[sorted.length - 1];
  const areaD = `${d} L ${toX(last.x).toFixed(1)} ${plotBottom.toFixed(1)} L ${toX(first.x).toFixed(1)} ${plotBottom.toFixed(1)} Z`;
  const axisMidY = (plotTop + plotBottom) / 2;

  return `<svg viewBox="0 0 ${w} ${h}" width="100%" height="${h}" role="img" aria-label="横坐标日期，纵坐标粉丝数">
    <line x1="${plotLeft}" y1="${plotBottom}" x2="${plotRight}" y2="${plotBottom}" stroke="rgba(255,255,255,.24)" stroke-width="1" />
    <line x1="${plotLeft}" y1="${plotTop}" x2="${plotLeft}" y2="${plotBottom}" stroke="rgba(255,255,255,.24)" stroke-width="1" />
    <path d="${areaD}" fill="rgba(255,255,255,.07)" stroke="none" />
    <path d="${d}" fill="none" stroke="rgba(255,255,255,.78)" stroke-width="2.2" stroke-linecap="round" />
    <text x="${plotLeft}" y="${h - 8}" fill="rgba(255,255,255,.60)" font-size="10">${shortDate(first.date)}</text>
    <text x="${plotRight}" y="${h - 8}" text-anchor="end" fill="rgba(255,255,255,.60)" font-size="10">${shortDate(last.date)}</text>
    <text x="${(plotLeft + plotRight) / 2}" y="${h - 8}" text-anchor="middle" fill="rgba(255,255,255,.66)" font-size="11">日期</text>
    <text x="${plotLeft - 6}" y="${plotTop + 4}" text-anchor="end" fill="rgba(255,255,255,.60)" font-size="10">${maxY.toLocaleString()}</text>
    <text x="${plotLeft - 6}" y="${plotBottom + 4}" text-anchor="end" fill="rgba(255,255,255,.60)" font-size="10">${minY.toLocaleString()}</text>
    <text x="15" y="${axisMidY}" transform="rotate(-90 15 ${axisMidY})" text-anchor="middle" fill="rgba(255,255,255,.66)" font-size="11">粉丝数</text>
  </svg>`;
}

const byMember = (m: "fiona" | "gladys" | "both") => rows.filter((r) => r.member === m);

function memberName(member: "fiona" | "gladys" | "both") {
  if (member === "fiona") return "心宜";
  if (member === "gladys") return "思诺";
  return "双人";
}

function dateToX(dateStr: string) {
  // YYYY-MM-DD -> day index
  const [y, m, d] = dateStr.split("-").map(Number);
  const dt = new Date(y, m - 1, d);
  return Math.floor(dt.getTime() / 86400000);
}

const gladysPts = byMember("gladys").map((r) => ({ x: dateToX(r.date), y: r.followers, date: r.date }));
const fionaPtsWithDate = byMember("fiona").map((r) => ({ x: dateToX(r.date), y: r.followers, date: r.date }));

const dailyByMember = new Map<"fiona" | "gladys" | "both", Map<string, number>>();
for (const row of rows) {
  if (!dailyByMember.has(row.member)) dailyByMember.set(row.member, new Map());
  dailyByMember.get(row.member)?.set(row.date, row.followers);
}

const deltaByMemberDate = new Map<string, number | null>();
for (const [member, daily] of dailyByMember) {
  const dates = [...daily.keys()].sort((a, b) => a.localeCompare(b));
  for (let i = 0; i < dates.length; i += 1) {
    const date = dates[i];
    if (i === 0) {
      deltaByMemberDate.set(`${member}|${date}`, null);
      continue;
    }
    const prevDate = dates[i - 1];
    const delta = (daily.get(date) ?? 0) - (daily.get(prevDate) ?? 0);
    deltaByMemberDate.set(`${member}|${date}`, delta);
  }
}

const rowsWithDelta = rows.map((r) => ({
  ...r,
  delta: deltaByMemberDate.get(`${r.member}|${r.date}`) ?? null,
}));

function formatDelta(delta: number | null) {
  if (delta === null) return "—";
  if (delta === 0) return "0";
  return delta > 0 ? `+${delta.toLocaleString()}` : delta.toLocaleString();
}

function deltaClass(delta: number | null) {
  if (delta === null || delta === 0) return "flat";
  return delta > 0 ? "up" : "down";
}
---
<BaseLayout title="粉丝数据｜闪耀舞台" description="粉丝数量与成长记录快照">
  <NavBar slot="nav" active="stats" />

  <Section title="粉丝数趋势">
    <div class="grid cols-2">
      <div class="panel">
        <div class="pt">心宜</div>
        <div class="svg" set:html={spark(fionaPtsWithDate)} />
      </div>
      <div class="panel">
        <div class="pt">思诺</div>
        <div class="svg" set:html={spark(gladysPts)} />
      </div>
    </div>
  </Section>

  <div class="table-wrap">
    <div class="table">
      <div class="tr th">
        <div>日期</div>
        <div>成员</div>
        <div>粉丝数</div>
        <div>较昨日</div>
      </div>
      {rowsWithDelta.slice().reverse().map((r) => (
        <div class="tr">
          <div class="muted">{formatDateCN(r.date)}</div>
          <div><span class="pill">{memberName(r.member)}</span></div>
          <div class="num">{r.followers.toLocaleString()}</div>
          <div class:list={["delta", deltaClass(r.delta)]}>{formatDelta(r.delta)}</div>
        </div>
      ))}
    </div>

    {!rows.length && <p class="p">还没有 metrics 数据。去 src/content/metrics/all.json 填写，或运行 npm run fetch:metrics。</p>}
  </div>

  <style lang="scss">
    @use "../styles/mixins" as m;

    .panel {
      @include m.glass;
      border-radius: var(--r-lg);
      padding: 12px 12px;
    }
    .pt {
      font-weight: 800;
      margin-bottom: 8px;
    }
    .svg :global(svg) {
      display: block;
    }

    .table-wrap {
      margin-top: 18px;
    }
    .table {
      @include m.glass;
      border-radius: var(--r-lg);
      overflow: hidden;
    }
    .tr {
      display: grid;
      grid-template-columns: 140px 90px minmax(120px, 1fr) minmax(90px, 0.8fr);
      gap: 10px;
      padding: 10px 12px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      align-items: center;
    }
    .tr.th {
      border-top: 0;
      background: rgba(255, 255, 255, 0.05);
      font-size: 12px;
      color: rgba(255, 255, 255, 0.65);
      letter-spacing: 0.3px;
    }
    .muted {
      color: rgba(255, 255, 255, 0.62);
      font-size: 13px;
    }
    .num {
      font-variant-numeric: tabular-nums;
    }
    .delta {
      font-variant-numeric: tabular-nums;
    }
    .delta.up {
      color: #9df2b7;
    }
    .delta.down {
      color: #ffb0b7;
    }
    .delta.flat {
      color: rgba(255, 255, 255, 0.6);
    }
    .pill {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(0, 0, 0, 0.18);
      color: rgba(255, 255, 255, 0.78);
    }

    @media (max-width: 860px) {
      .tr {
        grid-template-columns: 1fr;
      }
    }
  </style>
</BaseLayout>
