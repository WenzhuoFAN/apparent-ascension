---
import BaseLayout from "../layouts/BaseLayout.astro";
import NavBar from "../components/NavBar.astro";

const defaultTitle = "æœ¬æœˆç›´æ’­æ—¥ç¨‹";
const roomCoverMap = {
  fiona: "/images/FionaLive.jpg",
  gladys: "/images/GladysLive.jpg",
};
---
<BaseLayout title="æ—¥ç¨‹è¡¨ï½œé—ªè€€èˆå°" description="æ¯å‘¨ç›´æ’­æ—¥ç¨‹è¡¨ï¼ˆæ‰‹åŠ¨ç»´æŠ¤ï¼‰">
  <NavBar slot="nav" active="schedule" />

  <h1 class="h1">ç›´æ’­æ—¥ç¨‹è¡¨ ğŸ—“ï¸</h1>
  <p class="p">ä½ æ¯å‘¨æ‰‹åŠ¨æ›´æ–°å³å¯ï¼šæ”¹æ ‡é¢˜ã€æ—¥æœŸã€æ—¶é—´ã€ç›´æ’­é—´ã€‚ä¿å­˜åä¼šæ˜¾ç¤ºåˆ°ä¸‹æ–¹â€œå·²ä¿å­˜æ—¥ç¨‹â€ã€‚</p>

  <section class="calendar-wrap">
    <div class="calendar-head">
      <h2 class="h2">æœ¬æœˆæ—¥å†</h2>
      <button class="edit-btn" id="open-editor" type="button" hidden>ç¼–è¾‘</button>
    </div>
    <div class="calendar-month" id="calendar-month-label">--</div>
    <div class="calendar-weekdays">
      <span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span><span>å››</span><span>äº”</span><span>å…­</span><span>æ—¥</span>
    </div>
    <div class="calendar-grid" id="calendar-grid"></div>
  </section>

  <section class="saved-sec">
    <div id="saved-list"></div>
    <p class="p" id="saved-empty">æš‚æ— å·²ä¿å­˜æ—¥ç¨‹ã€‚</p>
  </section>

  <div class="editor-modal" id="editor-modal" hidden>
    <div class="editor-panel">
      <div class="editor-head">
        <h3>æ—¥ç¨‹ç¼–è¾‘</h3>
        <button class="close-btn" id="close-editor" type="button" aria-label="å…³é—­">Ã—</button>
      </div>

      <label class="field">
        <span>æ ‡é¢˜</span>
        <input id="title-input" type="text" placeholder="ä¾‹å¦‚ï¼šã€å¿ƒå®œæ€è¯ºçš„èŠå¤©å®¤ã€‘é©¬å¹´å¤§å‰ï¼" />
      </label>

      <label class="field">
        <span>æ—¥æœŸ</span>
        <input id="date-input" type="date" />
      </label>

      <label class="field">
        <span>æ—¶é—´</span>
        <input id="time-input" type="time" step="600" />
      </label>

      <label class="field">
        <span>ç›´æ’­é—´</span>
        <select id="room-input">
          <option value="fiona">å¿ƒå®œ</option>
          <option value="gladys">æ€è¯º</option>
        </select>
      </label>

      <div class="field">
        <span>ç›´æ’­å°é¢é¢„è§ˆï¼ˆè‡ªåŠ¨ï¼‰</span>
        <img id="cover-preview" class="cover-preview" alt="" hidden />
        <div id="cover-preview-empty" class="muted">æœªæ‰¾åˆ°å°é¢ï¼Œè¯·æ£€æŸ¥ `public/images/FionaLive.jpg` ä¸ `public/images/GladysLive.jpg`ã€‚</div>
      </div>

      <div class="editor-actions">
        <button class="edit-btn primary" id="save-entry" type="button">ä¿å­˜</button>
        <button class="edit-btn" id="clear-all" type="button">æ¸…ç©ºå…¨éƒ¨</button>
        <button class="edit-btn" id="cancel-editor" type="button">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <script define:vars={{ defaultTitle, roomCoverMap }}>
    (() => {
      const CONTENT_KEY = "schedule.manual.entries.v3";
      const fallbackTitle = String(defaultTitle || "æœ¬æœˆç›´æ’­æ—¥ç¨‹");
      const coverMap = roomCoverMap || { fiona: "", gladys: "" };
      const roomLabelMap = { fiona: "å¿ƒå®œ", gladys: "æ€è¯º" };
      const roomMarkMap = { fiona: "ğŸ¦­", gladys: "ğŸš" };

      const openBtn = document.getElementById("open-editor");
      const modal = document.getElementById("editor-modal");
      const closeBtn = document.getElementById("close-editor");
      const cancelBtn = document.getElementById("cancel-editor");
      const saveBtn = document.getElementById("save-entry");
      const clearBtn = document.getElementById("clear-all");

      const titleInput = document.getElementById("title-input");
      const dateInput = document.getElementById("date-input");
      const timeInput = document.getElementById("time-input");
      const roomInput = document.getElementById("room-input");
      const previewImg = document.getElementById("cover-preview");
      const previewEmpty = document.getElementById("cover-preview-empty");

      const savedList = document.getElementById("saved-list");
      const savedEmpty = document.getElementById("saved-empty");
      const monthLabel = document.getElementById("calendar-month-label");
      const calendarGrid = document.getElementById("calendar-grid");

      if (!openBtn || !modal || !closeBtn || !cancelBtn || !saveBtn || !clearBtn) return;
      if (!titleInput || !dateInput || !timeInput || !roomInput || !previewImg || !previewEmpty) return;
      if (!savedList || !savedEmpty || !monthLabel || !calendarGrid) return;

      let entriesState = [];
      let isAdmin = false;
      openBtn.hidden = true;

      const now = new Date();
      const nowDateISO = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}-${String(now.getDate()).padStart(2, "0")}`;
      const pad2 = (n) => String(n).padStart(2, "0");
      const normalizeTimeTo10Min = (time) => {
        const match = String(time || "").match(/^(\d{2}):(\d{2})$/);
        if (!match) return "";
        let hh = Number(match[1]);
        let mm = Number(match[2]);
        if (Number.isNaN(hh) || Number.isNaN(mm)) return "";

        mm = Math.round(mm / 10) * 10;
        if (mm >= 60) {
          mm = 0;
          hh = (hh + 1) % 24;
        }
        return `${pad2(hh)}:${pad2(mm)}`;
      };
      const nowTimeISO = normalizeTimeTo10Min(`${pad2(now.getHours())}:${pad2(now.getMinutes())}`) || "20:00";

      const sortEntries = (entries) =>
        [...entries].sort((a, b) => {
          const ka = `${a.date}T${a.time}`;
          const kb = `${b.date}T${b.time}`;
          return ka.localeCompare(kb);
        });

      const contentUrl = (admin = false) =>
        `${admin ? "/api/admin/content/" : "/api/content/"}${encodeURIComponent(CONTENT_KEY)}`;

      const fetchJson = async (url, init = {}) => {
        const response = await fetch(url, { cache: "no-store", ...init });
        let payload = null;
        try {
          payload = await response.json();
        } catch {
          payload = null;
        }
        return { response, payload };
      };

      const loadAdminState = async () => {
        try {
          const { response, payload } = await fetchJson("/api/admin/session");
          if (!response.ok) {
            isAdmin = false;
            openBtn.hidden = true;
            return;
          }
          isAdmin = !!payload?.authenticated;
          openBtn.hidden = !isAdmin;
        } catch {
          isAdmin = false;
          openBtn.hidden = true;
        }
      };

      const loadEntries = async () => {
        try {
          const { response, payload } = await fetchJson(contentUrl(false));
          if (!response.ok || !payload?.ok || !Array.isArray(payload.data)) {
            entriesState = [];
            return;
          }
          entriesState = sortEntries(payload.data);
        } catch {
          entriesState = [];
        }
      };

      const persistEntries = async (nextEntries) => {
        if (!isAdmin) {
          alert("è¯·å…ˆç™»å½•ç®¡ç†å‘˜è´¦å·ï¼š/admin");
          return false;
        }

        const normalized = sortEntries(nextEntries);
        const { response, payload } = await fetchJson(contentUrl(true), {
          method: "PUT",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ data: normalized }),
        });

        if (response.status === 401) {
          isAdmin = false;
          openBtn.hidden = true;
          alert("ç®¡ç†å‘˜ä¼šè¯å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½• /adminã€‚");
          return false;
        }
        if (!response.ok || !payload?.ok || !Array.isArray(payload.data)) {
          alert(`ä¿å­˜å¤±è´¥ï¼š${payload?.message || response.statusText}`);
          return false;
        }

        entriesState = sortEntries(payload.data);
        return true;
      };

      const getCoverByRoom = (room) => (room === "gladys" ? String(coverMap.gladys || "") : String(coverMap.fiona || ""));

      const formatDateCN = (date) => {
        const m = String(date || "").match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (!m) return date || "--";
        return `${Number(m[1])}å¹´${Number(m[2])}æœˆ${Number(m[3])}æ—¥`;
      };

      const renderPreviewByRoom = (room) => {
        const src = getCoverByRoom(room);
        if (!src) {
          previewImg.hidden = true;
          previewImg.removeAttribute("src");
          previewEmpty.hidden = false;
          return;
        }

        previewImg.onerror = () => {
          previewImg.hidden = true;
          previewEmpty.hidden = false;
        };
        previewImg.onload = () => {
          previewImg.hidden = false;
          previewEmpty.hidden = true;
        };
        previewImg.src = src;
      };

      const renderSavedList = (entries) => {
        savedList.innerHTML = "";
        if (!entries.length) {
          savedEmpty.hidden = false;
          return;
        }

        savedEmpty.hidden = true;
        entries.forEach((entry) => {
          const card = document.createElement("article");
          card.className = "saved-card";

          const main = document.createElement("div");
          main.className = "saved-main";

          const when = document.createElement("div");
          when.className = "saved-when";
          when.textContent = `${formatDateCN(entry.date)} ${entry.time}`;

          const title = document.createElement("div");
          title.className = "saved-title";
          title.textContent = entry.title || fallbackTitle;

          const meta = document.createElement("div");
          meta.className = "saved-meta";
          meta.textContent = `ç›´æ’­é—´ï¼š${roomLabelMap[entry.room]}`;

          main.append(when, title, meta);

          const coverWrap = document.createElement("div");
          coverWrap.className = "saved-cover-wrap";
          const cover = document.createElement("img");
          cover.className = "saved-cover";
          cover.alt = "";
          cover.loading = "lazy";
          cover.src = getCoverByRoom(entry.room);
          cover.onerror = () => {
            coverWrap.innerHTML = '<div class="saved-cover-miss">å°é¢ç¼ºå¤±</div>';
          };
          coverWrap.appendChild(cover);

          card.append(main, coverWrap);
          savedList.appendChild(card);
        });
      };

      const renderCalendar = (entries) => {
        const year = now.getFullYear();
        const month = now.getMonth() + 1;

        monthLabel.textContent = `${year}å¹´${month}æœˆ`;
        calendarGrid.innerHTML = "";

        const firstDay = new Date(year, month - 1, 1);
        const daysInMonth = new Date(year, month, 0).getDate();
        const start = (firstDay.getDay() + 6) % 7; // Monday=0

        const marksByDate = new Map();
        entries.forEach((entry) => {
          if (!entry.date?.startsWith(`${year}-${String(month).padStart(2, "0")}-`)) return;
          const set = marksByDate.get(entry.date) || new Set();
          set.add(entry.room);
          marksByDate.set(entry.date, set);
        });

        for (let i = 0; i < start; i += 1) {
          const blank = document.createElement("div");
          blank.className = "cal-cell is-empty";
          calendarGrid.appendChild(blank);
        }

        for (let day = 1; day <= daysInMonth; day += 1) {
          const dateKey = `${year}-${String(month).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
          const cell = document.createElement("div");
          cell.className = "cal-cell";

          const dayEl = document.createElement("div");
          dayEl.className = "cal-day";
          dayEl.textContent = String(day);

          const marks = document.createElement("div");
          marks.className = "cal-marks";
          const roomSet = marksByDate.get(dateKey);
          if (roomSet?.has("fiona")) {
            const f = document.createElement("span");
            f.className = "cal-mark fiona";
            f.textContent = roomMarkMap.fiona;
            marks.appendChild(f);
          }
          if (roomSet?.has("gladys")) {
            const g = document.createElement("span");
            g.className = "cal-mark gladys";
            g.textContent = roomMarkMap.gladys;
            marks.appendChild(g);
          }

          if (dateKey === nowDateISO) {
            cell.classList.add("is-today");
          }

          cell.append(dayEl, marks);
          calendarGrid.appendChild(cell);
        }
      };

      const renderAll = () => {
        const entries = sortEntries(entriesState);
        renderSavedList(entries);
        renderCalendar(entries);
      };

      const openModal = () => {
        if (!isAdmin) return;
        titleInput.value = fallbackTitle;
        dateInput.value = nowDateISO;
        timeInput.value = nowTimeISO;
        roomInput.value = "fiona";
        renderPreviewByRoom("fiona");
        modal.hidden = false;
      };

      const closeModal = () => {
        modal.hidden = true;
      };

      roomInput.addEventListener("change", () => {
        renderPreviewByRoom(roomInput.value);
      });
      timeInput.addEventListener("change", () => {
        const fixed = normalizeTimeTo10Min(timeInput.value);
        if (fixed) timeInput.value = fixed;
      });

      openBtn.addEventListener("click", openModal);
      closeBtn.addEventListener("click", closeModal);
      cancelBtn.addEventListener("click", closeModal);

      saveBtn.addEventListener("click", async () => {
        if (!dateInput.value || !timeInput.value) {
          alert("è¯·å…ˆå¡«å†™æ—¥æœŸå’Œæ—¶é—´ã€‚");
          return;
        }

        const room = roomInput.value === "gladys" ? "gladys" : "fiona";
        const entry = {
          title: titleInput.value.trim() || fallbackTitle,
          date: dateInput.value,
          time: normalizeTimeTo10Min(timeInput.value) || timeInput.value,
          room,
          updatedAt: new Date().toISOString(),
        };

        const key = `${entry.date}|${entry.time}|${entry.room}`;
        const next = entriesState.filter((x) => `${x.date}|${x.time}|${x.room}` !== key);
        next.push(entry);
        const ok = await persistEntries(next);
        if (!ok) return;
        renderAll();
        closeModal();
      });

      clearBtn.addEventListener("click", async () => {
        if (!confirm("ç¡®å®šæ¸…ç©ºå…¨éƒ¨å·²ä¿å­˜æ—¥ç¨‹å—ï¼Ÿ")) return;
        const ok = await persistEntries([]);
        if (!ok) return;
        renderAll();
        closeModal();
      });

      modal.addEventListener("click", (event) => {
        if (event.target === modal) closeModal();
      });

      window.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && !modal.hidden) closeModal();
      });

      (async () => {
        await Promise.all([loadEntries(), loadAdminState()]);
        renderAll();
      })();
    })();
  </script>

  <style lang="scss">
  @use "../styles/mixins" as m;

  .calendar-wrap{
    @include m.glass;
    border-radius: var(--r-xl);
    padding: 14px;
    margin-bottom: 14px;
  }
  .calendar-head{
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
  }
  .calendar-month{
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 8px;
  }
  .calendar-weekdays{
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    margin-bottom: 8px;
    color: rgba(255,255,255,.66);
    font-size: 12px;
    text-align: center;
  }
  .calendar-weekdays span{
    padding: 4px 0;
  }

  :global(.calendar-grid){
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
  }
  :global(.cal-cell){
    min-height: 64px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.18);
    padding: 8px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  :global(.cal-cell.is-empty){
    border-style: dashed;
    opacity: .32;
  }
  :global(.cal-cell.is-today){
    border-color: rgba(160,225,196,.58);
    box-shadow: 0 0 0 1px rgba(160,225,196,.24) inset;
  }
  :global(.cal-day){
    font-size: 12px;
    color: rgba(255,255,255,.82);
  }
  :global(.cal-marks){
    display: flex;
    gap: 4px;
    align-items: center;
  }
  :global(.cal-mark){
    font-size: 16px;
    line-height: 1;
  }

  #saved-list{
    display: grid;
    gap: 10px;
  }
  :global(.saved-card){
    @include m.glass;
    border-radius: var(--r-lg);
    padding: 12px;
    display: grid;
    grid-template-columns: 1fr 220px;
    gap: 12px;
    align-items: center;
  }
  :global(.saved-main){
    min-width: 0;
  }
  :global(.saved-when){
    font-size: 13px;
    color: rgba(255,255,255,.72);
    margin-bottom: 6px;
  }
  :global(.saved-title){
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 4px;
  }
  :global(.saved-meta){
    color: rgba(255,255,255,.62);
    font-size: 13px;
  }
  :global(.saved-cover-wrap){
    min-height: 120px;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.2);
  }
  :global(.saved-cover){
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  :global(.saved-cover-miss){
    width: 100%;
    height: 100%;
    min-height: 120px;
    display: grid;
    place-items: center;
    color: rgba(255,255,255,.58);
    font-size: 13px;
  }

  .edit-btn{
    border: 1px solid rgba(255,255,255,.16);
    border-radius: 999px;
    background: rgba(20,20,30,.5);
    color: rgba(255,255,255,.9);
    padding: 7px 12px;
    font-size: 13px;
    cursor: pointer;
  }
  .edit-btn[hidden]{
    display: none !important;
  }
  .edit-btn.primary{
    background: rgba(74, 206, 148, .18);
    border-color: rgba(74, 206, 148, .5);
    color: rgba(224,255,241,.98);
  }
  .edit-btn:hover{
    border-color: rgba(255,255,255,.30);
    background: rgba(40,40,60,.62);
  }

  .editor-modal{
    position: fixed;
    inset: 0;
    z-index: 90;
    display: grid;
    place-items: center;
    background: rgba(0,0,0,.56);
    padding: 16px;
  }
  .editor-modal[hidden]{ display: none !important; }
  .editor-panel{
    width: min(620px, 100%);
    border-radius: 20px;
    padding: 16px;
    @include m.glass;
  }
  .editor-head{
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }
  .editor-head h3{
    margin: 0;
    font-size: 18px;
  }
  .close-btn{
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 1px solid rgba(255,255,255,.2);
    background: rgba(0,0,0,.3);
    color: rgba(255,255,255,.9);
    cursor: pointer;
  }
  .field{
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 10px;
  }
  .field span{
    font-size: 12px;
    color: rgba(255,255,255,.78);
  }
  .field input,
  .field select{
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,.16);
    background: rgba(0,0,0,.34);
    color: rgba(255,255,255,.92);
    padding: 10px;
    font-size: 14px;
    font-family: inherit;
  }
  .field input[type="date"],
  .field input[type="time"]{
    color-scheme: dark;
    padding-right: 42px;
  }
  .field input[type="date"]::-webkit-calendar-picker-indicator,
  .field input[type="time"]::-webkit-calendar-picker-indicator{
    opacity: .95;
    filter: invert(1) brightness(1.2);
    cursor: pointer;
  }
  .cover-preview{
    width: 100%;
    max-height: 260px;
    object-fit: contain;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.2);
    background: rgba(0,0,0,.2);
  }
  .muted{
    color: rgba(255,255,255,.56);
    font-size: 12px;
  }
  .editor-actions{
    display: flex;
    gap: 8px;
    margin-top: 12px;
  }

  @media (max-width: 860px){
    :global(.saved-card){
      grid-template-columns: 1fr;
    }
    :global(.calendar-grid){
      gap: 6px;
    }
    :global(.cal-cell){
      min-height: 56px;
    }
  }
  </style>
</BaseLayout>
