---
import BaseLayout from "../layouts/BaseLayout.astro";
import NavBar from "../components/NavBar.astro";
import Section from "../components/Section.astro";
const defaultPosterTitle = "æœ¬å‘¨æ—¥ç¨‹è¡¨";
const roomCoverMap = {
  fiona: "/images/FionaLive.jpg",
  gladys: "/images/GladysLive.jpg",
};
---
<BaseLayout title="æ—¥ç¨‹è¡¨ï½œé—ªè€€èˆå°" description="æ¯å‘¨ç›´æ’­æ—¥ç¨‹è¡¨ï¼ˆæ‰‹åŠ¨ç»´æŠ¤ï¼‰">
  <NavBar slot="nav" active="schedule" />

  <h1 class="h1">æ¯å‘¨ç›´æ’­æ—¥ç¨‹è¡¨ ğŸ—“ï¸</h1>
  <p class="p">ä½ æ¯å‘¨æ‰‹åŠ¨æ›´æ–°å³å¯ï¼šæ”¹æ ‡é¢˜ã€æ—¥æœŸã€æ—¶é—´ã€ç›´æ’­é—´ï¼Œå°é¢ä¼šæŒ‰ç›´æ’­é—´è‡ªåŠ¨åˆ‡æ¢ã€‚</p>

  <section class="poster-wrap">
    <div class="poster-head">
      <h2 class="h2">æœ¬å‘¨å°é¢</h2>
      <button class="edit-btn" id="open-poster-editor" type="button">ç¼–è¾‘</button>
    </div>

    <article class="poster-card">
      <div class="poster-title" id="poster-title">{defaultPosterTitle}</div>
      <div class="poster-sub" id="poster-sub">æ—¥æœŸï¼š-- ï½œ æ—¶é—´ï¼š-- ï½œ ç›´æ’­é—´ï¼š--</div>
      <img id="poster-image" class="poster-image" alt="" hidden />
      <div id="poster-empty" class="poster-empty">æœªæ‰¾åˆ°å°é¢å›¾ç‰‡ï¼Œè¯·æ£€æŸ¥ `public/images/FionaLive.jpg` ä¸ `public/images/GladysLive.jpg`ã€‚</div>
    </article>
  </section>

  <Section title="æœ¬å‘¨æ—¥ç¨‹">
    <div class="list">
      <div class="row" id="manual-row" hidden>
        <div class="when" id="manual-when">--</div>
        <div class="what">
          <div class="t" id="manual-title">--</div>
          <div class="meta" id="manual-meta">ç›´æ’­é—´ï¼š--</div>
        </div>
        <div class="go">
          <span class="muted" id="manual-status">å·²ä¿å­˜</span>
        </div>
      </div>
    </div>
    <p class="p" id="manual-empty">æš‚æ— å·²ä¿å­˜æ—¥ç¨‹ï¼Œç‚¹å‡»ä¸Šæ–¹â€œç¼–è¾‘â€æ·»åŠ ã€‚</p>
  </Section>

  <div class="editor-modal" id="poster-editor-modal" hidden>
    <div class="editor-panel">
      <div class="editor-head">
        <h3>å°é¢ç¼–è¾‘</h3>
        <button class="close-btn" id="close-poster-editor" type="button" aria-label="å…³é—­">Ã—</button>
      </div>

      <label class="field">
        <span>æ ‡é¢˜</span>
        <input id="poster-title-input" type="text" placeholder="ä¾‹å¦‚ï¼šWeek of 2026-03-02" />
      </label>

      <label class="field">
        <span>æ—¥æœŸ</span>
        <input id="poster-date-input" type="date" />
      </label>

      <label class="field">
        <span>æ—¶é—´</span>
        <input id="poster-time-input" type="time" />
      </label>

      <label class="field">
        <span>ç›´æ’­é—´</span>
        <select id="poster-room-input">
          <option value="fiona">å¿ƒå®œ</option>
          <option value="gladys">æ€è¯º</option>
        </select>
      </label>

      <div class="field">
        <span>å°é¢é¢„è§ˆï¼ˆè‡ªåŠ¨ï¼‰</span>
        <img id="poster-cover-preview" class="cover-preview" alt="" hidden />
        <div id="poster-cover-empty" class="muted">å½“å‰ç›´æ’­é—´å¯¹åº”å°é¢æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡è·¯å¾„ã€‚</div>
      </div>

      <p class="p path-note">å°é¢è·¯å¾„å¯åœ¨æœ¬æ–‡ä»¶é¡¶éƒ¨ `roomCoverMap` ä¿®æ”¹ã€‚</p>

      <div class="editor-actions">
        <button class="edit-btn primary" id="save-poster" type="button">ä¿å­˜</button>
        <button class="edit-btn" id="clear-poster" type="button">æ¸…ç©º</button>
        <button class="edit-btn" id="cancel-poster" type="button">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <script define:vars={{ defaultPosterTitle, roomCoverMap }}>
    (() => {
      const STORAGE_KEY = "schedule.poster.v1";
      const fallbackTitle = String(defaultPosterTitle || "æœ¬å‘¨æ—¥ç¨‹è¡¨");
      const coverMap = roomCoverMap || { fiona: "", gladys: "" };
      const roomLabelMap = { fiona: "å¿ƒå®œ", gladys: "æ€è¯º" };

      const openBtn = document.getElementById("open-poster-editor");
      const modal = document.getElementById("poster-editor-modal");
      const closeBtn = document.getElementById("close-poster-editor");
      const cancelBtn = document.getElementById("cancel-poster");
      const saveBtn = document.getElementById("save-poster");
      const clearBtn = document.getElementById("clear-poster");

      const titleInput = document.getElementById("poster-title-input");
      const dateInput = document.getElementById("poster-date-input");
      const timeInput = document.getElementById("poster-time-input");
      const roomInput = document.getElementById("poster-room-input");
      const preview = document.getElementById("poster-cover-preview");
      const previewEmpty = document.getElementById("poster-cover-empty");

      const titleEl = document.getElementById("poster-title");
      const subEl = document.getElementById("poster-sub");
      const imageEl = document.getElementById("poster-image");
      const emptyEl = document.getElementById("poster-empty");
      const manualRow = document.getElementById("manual-row");
      const manualWhenEl = document.getElementById("manual-when");
      const manualTitleEl = document.getElementById("manual-title");
      const manualMetaEl = document.getElementById("manual-meta");
      const manualStatusEl = document.getElementById("manual-status");
      const manualEmptyEl = document.getElementById("manual-empty");

      if (!openBtn || !modal || !closeBtn || !cancelBtn || !saveBtn || !clearBtn) return;
      if (!titleInput || !dateInput || !timeInput || !roomInput || !preview || !previewEmpty || !titleEl || !subEl || !imageEl || !emptyEl) return;
      if (!manualRow || !manualWhenEl || !manualTitleEl || !manualMetaEl || !manualStatusEl || !manualEmptyEl) return;

      const readPoster = () => {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return null;
          const parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== "object") return null;
          return {
            title: typeof parsed.title === "string" ? parsed.title : "",
            date: typeof parsed.date === "string" ? parsed.date : "",
            time: typeof parsed.time === "string" ? parsed.time : "",
            room: parsed.room === "gladys" ? "gladys" : "fiona",
          };
        } catch {
          return null;
        }
      };

      const writePoster = (payload) => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      };

      const getCoverByRoom = (room) => (room === "gladys" ? String(coverMap.gladys || "") : String(coverMap.fiona || ""));
      const formatDateCN = (date) => {
        const text = String(date || "").trim();
        const m = text.match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (!m) return text || "--";
        return `${Number(m[1])}å¹´${Number(m[2])}æœˆ${Number(m[3])}æ—¥`;
      };

      const applyImage = (imgEl, emptyStateEl, src, emptyText) => {
        if (!src) {
          imgEl.hidden = true;
          imgEl.removeAttribute("src");
          if (emptyStateEl) {
            emptyStateEl.textContent = emptyText;
            emptyStateEl.hidden = false;
          }
          return;
        }

        imgEl.onerror = () => {
          imgEl.hidden = true;
          if (emptyStateEl) {
            emptyStateEl.textContent = `æ‰¾ä¸åˆ°å°é¢ï¼š${src}`;
            emptyStateEl.hidden = false;
          }
        };
        imgEl.onload = () => {
          imgEl.hidden = false;
          if (emptyStateEl) emptyStateEl.hidden = true;
        };
        imgEl.src = src;
      };

      const renderManualRow = (payload) => {
        if (!payload) {
          manualRow.hidden = true;
          manualEmptyEl.hidden = false;
          return;
        }

        const room = payload.room === "gladys" ? "gladys" : "fiona";
        const title = payload.title?.trim() || fallbackTitle;
        const date = formatDateCN(payload.date);
        const time = payload.time?.trim() || "--";

        manualWhenEl.textContent = `${date} ${time}`;
        manualTitleEl.textContent = title;
        manualMetaEl.textContent = `ç›´æ’­é—´ï¼š${roomLabelMap[room]}`;
        manualStatusEl.textContent = "å·²ä¿å­˜";
        manualRow.hidden = false;
        manualEmptyEl.hidden = true;
      };

      const renderPoster = (payload) => {
        const hasPayload = !!payload;
        const title = payload?.title?.trim() || fallbackTitle;
        const room = payload?.room === "gladys" ? "gladys" : "fiona";
        const date = payload?.date?.trim() || "--";
        const time = payload?.time?.trim() || "--";
        const roomLabel = hasPayload ? roomLabelMap[room] : "--";
        const cover = hasPayload ? getCoverByRoom(room) : "";

        titleEl.textContent = title;
        subEl.textContent = `æ—¥æœŸï¼š${date} ï½œ æ—¶é—´ï¼š${time} ï½œ ç›´æ’­é—´ï¼š${roomLabel}`;
        applyImage(imageEl, emptyEl, cover, "æœªæ‰¾åˆ°å°é¢å›¾ç‰‡ï¼Œè¯·æ£€æŸ¥ `public/images/FionaLive.jpg` ä¸ `public/images/GladysLive.jpg`ã€‚");
        renderManualRow(payload);
      };

      const setPreviewByRoom = (room) => {
        const cover = getCoverByRoom(room);
        applyImage(preview, previewEmpty, cover, "å½“å‰ç›´æ’­é—´å¯¹åº”å°é¢æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡è·¯å¾„ã€‚");
      };

      const openModal = () => {
        const current = readPoster();
        titleInput.value = current?.title || fallbackTitle;
        dateInput.value = current?.date || "";
        timeInput.value = current?.time || "";
        roomInput.value = current?.room || "fiona";
        setPreviewByRoom(roomInput.value);
        modal.hidden = false;
      };

      const closeModal = () => {
        modal.hidden = true;
      };

      roomInput.addEventListener("change", () => {
        setPreviewByRoom(roomInput.value);
      });

      openBtn.addEventListener("click", openModal);
      closeBtn.addEventListener("click", closeModal);
      cancelBtn.addEventListener("click", closeModal);

      saveBtn.addEventListener("click", () => {
        const payload = {
          title: titleInput.value.trim() || fallbackTitle,
          date: dateInput.value || "",
          time: timeInput.value || "",
          room: roomInput.value === "gladys" ? "gladys" : "fiona",
        };
        writePoster(payload);
        renderPoster(payload);
        closeModal();
      });

      clearBtn.addEventListener("click", () => {
        if (!confirm("ç¡®å®šæ¸…ç©ºå½“å‰é…ç½®å—ï¼Ÿ")) return;
        localStorage.removeItem(STORAGE_KEY);
        renderPoster(null);
        closeModal();
      });

      modal.addEventListener("click", (event) => {
        if (event.target === modal) closeModal();
      });

      window.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && !modal.hidden) closeModal();
      });

      renderPoster(readPoster());
    })();
  </script>

  <style lang="scss">
  @use "../styles/mixins" as m;

  .poster-wrap{
    @include m.glass;
    border-radius: var(--r-xl);
    padding: 14px;
    margin-bottom: 14px;
  }
  .poster-head{
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }
  .poster-card{
    border-radius: var(--r-lg);
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.14);
    padding: 12px;
  }
  .poster-title{
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 6px;
  }
  .poster-sub{
    color: rgba(255,255,255,.72);
    font-size: 13px;
    margin-bottom: 10px;
  }
  .poster-image{
    width: 100%;
    max-height: 420px;
    object-fit: contain;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.24);
    display: block;
  }
  .poster-empty{
    border-radius: 12px;
    border: 1px dashed rgba(255,255,255,.18);
    background: rgba(0,0,0,.14);
    min-height: 210px;
    display: grid;
    place-items: center;
    color: rgba(255,255,255,.56);
    font-size: 14px;
  }

  .list{ display: grid; gap: 10px; }
  .row{
    @include m.glass;
    border-radius: var(--r-lg);
    padding: 12px;
    display: grid;
    grid-template-columns: 200px 1fr 64px;
    gap: 12px;
    align-items: center;
  }
  .when{ font-size: 13px; color: rgba(255,255,255,.70); }
  .t{ font-weight: 700; }
  .meta{ color: rgba(255,255,255,.60); font-size: 13px; margin-top: 6px; }
  .muted{ color: rgba(255,255,255,.55); font-size: 12px; }
  .link{
    font-size: 12px;
    padding: 7px 10px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.14);
  }
  .link:hover{ background: rgba(0,0,0,.22); }

  .edit-btn{
    border: 1px solid rgba(255,255,255,.16);
    border-radius: 999px;
    background: rgba(20,20,30,.5);
    color: rgba(255,255,255,.9);
    padding: 7px 12px;
    font-size: 13px;
    cursor: pointer;
  }
  .edit-btn.primary{
    background: rgba(74, 206, 148, .18);
    border-color: rgba(74, 206, 148, .5);
    color: rgba(224,255,241,.98);
  }
  .edit-btn:hover{
    border-color: rgba(255,255,255,.30);
    background: rgba(40,40,60,.62);
  }

  .editor-modal{
    position: fixed;
    inset: 0;
    z-index: 90;
    display: grid;
    place-items: center;
    background: rgba(0,0,0,.56);
    padding: 16px;
  }
  .editor-modal[hidden]{ display: none !important; }
  .editor-panel{
    width: min(620px, 100%);
    border-radius: 20px;
    padding: 16px;
    @include m.glass;
  }
  .editor-head{
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }
  .editor-head h3{
    margin: 0;
    font-size: 18px;
  }
  .close-btn{
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 1px solid rgba(255,255,255,.2);
    background: rgba(0,0,0,.3);
    color: rgba(255,255,255,.9);
    cursor: pointer;
  }
  .field{
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 10px;
  }
  .field span{
    font-size: 12px;
    color: rgba(255,255,255,.78);
  }
  .field input{
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,.16);
    background: rgba(0,0,0,.34);
    color: rgba(255,255,255,.92);
    padding: 10px;
    font-size: 14px;
    font-family: inherit;
  }
  .field select{
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,.16);
    background: rgba(0,0,0,.34);
    color: rgba(255,255,255,.92);
    padding: 10px;
    font-size: 14px;
    font-family: inherit;
  }
  .cover-preview{
    width: 100%;
    max-height: 320px;
    object-fit: contain;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.2);
    background: rgba(0,0,0,.2);
  }
  .path-note{
    margin: 4px 0 0;
    color: rgba(255,255,255,.62);
    font-size: 12px;
  }
  .editor-actions{
    display: flex;
    gap: 8px;
    margin-top: 12px;
  }

  @media (max-width: 860px){
    .row{ grid-template-columns: 1fr; }
    .go{ justify-self: start; }
  }
  </style>
</BaseLayout>
